<?xml version="1.0" encoding="UTF-8"?>
<project version="4">
  <component name="CopilotDiffPersistence">
    <option name="pendingDiffs">
      <map>
        <entry key="$PROJECT_DIR$/app/account/AccountFormClient.tsx">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/app/account/AccountFormClient.tsx" />
              <option name="originalContent" value="&quot;use client&quot;;&#10;&#10;import { useState } from 'react';&#10;import Image from 'next/image';&#10;import GlowButton from '@/components/ui/GlowButton';&#10;import { withBasePath } from '@/lib/url';&#10;&#10;export default function AccountFormClient({ initialBio, initialAvatarUrl, initialBannerUrl }: { initialBio: string | null; initialAvatarUrl: string | null; initialBannerUrl: string | null; }) {&#10;  const [bio, setBio] = useState(initialBio || &quot;&quot;);&#10;  const [avatarUrl, setAvatarUrl] = useState&lt;string | null&gt;(initialAvatarUrl || null);&#10;  const [saving, setSaving] = useState(false);&#10;  const [removing, setRemoving] = useState(false);&#10;  const [message, setMessage] = useState&lt;string | null&gt;(null);&#10;  const [bannerUrl, setBannerUrl] = useState&lt;string | null&gt;(initialBannerUrl || null);&#10;  const [bannerMsg, setBannerMsg] = useState&lt;string | null&gt;(null);&#10;  const [bannerUploading, setBannerUploading] = useState(false);&#10;&#10;  async function handleUpload(e: React.ChangeEvent&lt;HTMLInputElement&gt;) {&#10;    const file = e.target.files?.[0];&#10;    if (!file) return;&#10;    setMessage(null);&#10;    const fd = new FormData();&#10;    fd.append('file', file);&#10;    try {&#10;      const res = await fetch('/api/account/upload', { method: 'POST', body: fd });&#10;      const data = await res.json();&#10;      if (!res.ok) throw new Error(data?.error || 'Upload fehlgeschlagen');&#10;      setAvatarUrl(data.url);&#10;      setMessage('Profilbild aktualisiert. Nicht vergessen zu speichern.');&#10;    } catch (err: unknown) {&#10;      const msg = err instanceof Error ? err.message : 'Upload fehlgeschlagen';&#10;      setMessage(msg);&#10;    }&#10;  }&#10;&#10;  async function handleSave(e: React.FormEvent) {&#10;    e.preventDefault();&#10;    setSaving(true);&#10;    setMessage(null);&#10;    try {&#10;      const res = await fetch('/api/account/profile', {&#10;        method: 'POST',&#10;        headers: { 'Content-Type': 'application/json' },&#10;        body: JSON.stringify({ bio, avatar_url: avatarUrl, banner_url: bannerUrl })&#10;      });&#10;      const data = await res.json();&#10;      if (!res.ok) throw new Error(data?.error || 'Speichern fehlgeschlagen');&#10;      setMessage('Profil gespeichert.');&#10;    } catch (err: unknown) {&#10;      const msg = err instanceof Error ? err.message : 'Speichern fehlgeschlagen';&#10;      setMessage(msg);&#10;    } finally {&#10;      setSaving(false);&#10;    }&#10;  }&#10;&#10;  async function handleBannerUpload(e: React.ChangeEvent&lt;HTMLInputElement&gt;) {&#10;    const file = e.target.files?.[0];&#10;    if (!file) return;&#10;    setBannerMsg(null);&#10;    setBannerUploading(true);&#10;    try {&#10;      const fd = new FormData();&#10;      fd.append('file', file);&#10;      const res = await fetch('/api/account/banner', { method: 'POST', body: fd });&#10;      const data = await res.json();&#10;      if (!res.ok) throw new Error(data?.error || 'Upload fehlgeschlagen');&#10;      setBannerUrl(data.url);&#10;      setBannerMsg('Banner aktualisiert. Nicht vergessen zu speichern.');&#10;    } catch (err: unknown) {&#10;      const msg = err instanceof Error ? err.message : 'Upload fehlgeschlagen';&#10;      setBannerMsg(msg);&#10;    } finally {&#10;      setBannerUploading(false);&#10;    }&#10;  }&#10;&#10;  async function handleRemove() {&#10;    if (!avatarUrl) return;&#10;    setRemoving(true);&#10;    setMessage(null);&#10;    try {&#10;      const res = await fetch('/api/account/profile', {&#10;        method: 'POST',&#10;        headers: { 'Content-Type': 'application/json' },&#10;        body: JSON.stringify({ bio, avatar_url: null })&#10;      });&#10;      const data = await res.json();&#10;      if (!res.ok) throw new Error(data?.error || 'Entfernen fehlgeschlagen');&#10;      setAvatarUrl(null);&#10;      setMessage('Profilbild entfernt.');&#10;    } catch (err: unknown) {&#10;      const msg = err instanceof Error ? err.message : 'Entfernen fehlgeschlagen';&#10;      setMessage(msg);&#10;    } finally {&#10;      setRemoving(false);&#10;    }&#10;  }&#10;&#10;  return (&#10;    &lt;form onSubmit={handleSave} className=&quot;space-y-6&quot;&gt;&#10;      {/* Banner */}&#10;      &lt;div className=&quot;space-y-3&quot;&gt;&#10;        &lt;label className=&quot;block text-sm font-medium text-[#f5f1ed]&quot;&gt;Profil-Banner&lt;/label&gt;&#10;        &lt;div className=&quot;rounded-xl overflow-hidden bg-[#38302b] border border-[#e89a7a]/20&quot;&gt;&#10;          {bannerUrl ? (&#10;            // eslint-disable-next-line @next/next/no-img-element&#10;            &lt;img&#10;              src={withBasePath(bannerUrl) || undefined}&#10;              alt=&quot;Banner&quot;&#10;              className=&quot;w-full h-40 object-cover&quot;&#10;              onError={(e) =&gt; {&#10;                const target = e.target as HTMLImageElement;&#10;                target.style.display = 'none';&#10;                if (target.nextElementSibling) {&#10;                  (target.nextElementSibling as HTMLElement).style.display = 'flex';&#10;                }&#10;              }}&#10;            /&gt;&#10;          ) : null}&#10;          &lt;div&#10;            className=&quot;w-full h-40 flex items-center justify-center text-[#b8aea5] text-sm&quot;&#10;            style={{ display: bannerUrl ? 'none' : 'flex' }}&#10;          &gt;&#10;            Kein Banner&#10;          &lt;/div&gt;&#10;        &lt;/div&gt;&#10;        &lt;div className=&quot;flex items-center gap-3&quot;&gt;&#10;          &lt;input type=&quot;file&quot; accept=&quot;image/*&quot; onChange={handleBannerUpload} className=&quot;block text-sm text-[#b8aea5] file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-[#e89a7a]/20 file:text-[#e89a7a] hover:file:bg-[#e89a7a]/30&quot; /&gt;&#10;          {bannerUrl &amp;&amp; (&#10;            &lt;GlowButton type=&quot;button&quot; variant=&quot;secondary&quot; onClick={() =&gt; { setBannerUrl(null); setBannerMsg('Banner entfernt. Nicht vergessen zu speichern.'); }} loading={bannerUploading}&gt;&#10;              Banner entfernen&#10;            &lt;/GlowButton&gt;&#10;          )}&#10;        &lt;/div&gt;&#10;        &lt;p className=&quot;text-xs text-[#8faf9d]&quot;&gt;Erlaubte Formate: JPG, PNG, WEBP, GIF. Max 10MB.&lt;/p&gt;&#10;        {bannerMsg &amp;&amp; &lt;div className=&quot;text-xs text-[#e89a7a]&quot;&gt;{bannerMsg}&lt;/div&gt;}&#10;      &lt;/div&gt;&#10;&#10;      {/* Avatar */}&#10;      &lt;div className=&quot;flex items-start gap-6&quot;&gt;&#10;        &lt;div className=&quot;w-24 h-24 rounded-xl overflow-hidden bg-[#38302b] flex items-center justify-center border border-[#e89a7a]/20&quot;&gt;&#10;          {avatarUrl ? (&#10;            // eslint-disable-next-line @next/next/no-img-element&#10;            &lt;img src={avatarUrl} alt=&quot;Avatar&quot; className=&quot;w-full h-full object-cover&quot; /&gt;&#10;          ) : (&#10;            &lt;span className=&quot;text-[#b8aea5] text-sm&quot;&gt;Kein Bild&lt;/span&gt;&#10;          )}&#10;        &lt;/div&gt;&#10;        &lt;div&gt;&#10;          &lt;label className=&quot;block text-sm font-medium text-[#f5f1ed] mb-2&quot;&gt;Profilbild&lt;/label&gt;&#10;          &lt;input type=&quot;file&quot; accept=&quot;image/*&quot; onChange={handleUpload} className=&quot;block text-sm text-[#b8aea5] file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-[#e89a7a]/20 file:text-[#e89a7a] hover:file:bg-[#e89a7a]/30&quot; /&gt;&#10;          &lt;p className=&quot;text-xs text-[#8faf9d] mt-2&quot;&gt;Erlaubte Formate: JPG, PNG, WEBP, GIF. Max 5MB.&lt;/p&gt;&#10;        &lt;/div&gt;&#10;      &lt;/div&gt;&#10;&#10;      &lt;div&gt;&#10;        &lt;label className=&quot;block text-sm font-medium text-[#f5f1ed] mb-2&quot;&gt;Bio&lt;/label&gt;&#10;        &lt;textarea&#10;          value={bio}&#10;          onChange={(e) =&gt; setBio(e.target.value)}&#10;          rows={5}&#10;          className=&quot;w-full rounded-lg bg-[#2a2520] border border-[#e89a7a]/20 p-3 text-sm text-[#f5f1ed] placeholder-[#b8aea5] focus:outline-none focus:ring-2 focus:ring-[#e89a7a]/40&quot;&#10;          placeholder=&quot;Erzähle kurz etwas über dich...&quot;&#10;        /&gt;&#10;        &lt;div className=&quot;text-xs text-[#b8aea5] mt-1&quot;&gt;{bio.length}/2000&lt;/div&gt;&#10;      &lt;/div&gt;&#10;&#10;      {message &amp;&amp; &lt;div className=&quot;text-sm text-[#e89a7a]&quot;&gt;{message}&lt;/div&gt;}&#10;&#10;      &lt;div className=&quot;flex gap-3&quot;&gt;&#10;        &lt;GlowButton type=&quot;submit&quot; loading={saving}&gt;&#10;          Speichern&#10;        &lt;/GlowButton&gt;&#10;        {avatarUrl &amp;&amp; (&#10;          &lt;GlowButton type=&quot;button&quot; variant=&quot;secondary&quot; onClick={handleRemove} loading={removing}&gt;&#10;            Bild entfernen&#10;          &lt;/GlowButton&gt;&#10;        )}&#10;      &lt;/div&gt;&#10;    &lt;/form&gt;&#10;  );&#10;}&#10;" />
              <option name="updatedContent" value="&quot;use client&quot;;&#10;&#10;import { useState } from 'react';&#10;import GlowButton from '@/components/ui/GlowButton';&#10;import { withBasePath } from '@/lib/url';&#10;import BannerImage from '@/components/BannerImage';&#10;import AvatarImage from '@/components/AvatarImage';&#10;&#10;export default function AccountFormClient({ initialBio, initialAvatarUrl, initialBannerUrl }: { initialBio: string | null; initialAvatarUrl: string | null; initialBannerUrl: string | null; }) {&#10;  const [bio, setBio] = useState(initialBio || &quot;&quot;);&#10;  const [avatarUrl, setAvatarUrl] = useState&lt;string | null&gt;(initialAvatarUrl || null);&#10;  const [saving, setSaving] = useState(false);&#10;  const [removing, setRemoving] = useState(false);&#10;  const [message, setMessage] = useState&lt;string | null&gt;(null);&#10;  const [bannerUrl, setBannerUrl] = useState&lt;string | null&gt;(initialBannerUrl || null);&#10;  const [bannerMsg, setBannerMsg] = useState&lt;string | null&gt;(null);&#10;  const [bannerUploading, setBannerUploading] = useState(false);&#10;&#10;  async function handleUpload(e: React.ChangeEvent&lt;HTMLInputElement&gt;) {&#10;    const file = e.target.files?.[0];&#10;    if (!file) return;&#10;    setMessage(null);&#10;    const fd = new FormData();&#10;    fd.append('file', file);&#10;    try {&#10;      const res = await fetch('/api/account/upload', { method: 'POST', body: fd });&#10;      const data = await res.json();&#10;      if (!res.ok) throw new Error(data?.error || 'Upload fehlgeschlagen');&#10;      setAvatarUrl(data.url);&#10;      setMessage('Profilbild aktualisiert. Nicht vergessen zu speichern.');&#10;    } catch (err: unknown) {&#10;      const msg = err instanceof Error ? err.message : 'Upload fehlgeschlagen';&#10;      setMessage(msg);&#10;    }&#10;  }&#10;&#10;  async function handleSave(e: React.FormEvent) {&#10;    e.preventDefault();&#10;    setSaving(true);&#10;    setMessage(null);&#10;    try {&#10;      const res = await fetch('/api/account/profile', {&#10;        method: 'POST',&#10;        headers: { 'Content-Type': 'application/json' },&#10;        body: JSON.stringify({ bio, avatar_url: avatarUrl, banner_url: bannerUrl })&#10;      });&#10;      const data = await res.json();&#10;      if (!res.ok) throw new Error(data?.error || 'Speichern fehlgeschlagen');&#10;      setMessage('Profil gespeichert.');&#10;    } catch (err: unknown) {&#10;      const msg = err instanceof Error ? err.message : 'Speichern fehlgeschlagen';&#10;      setMessage(msg);&#10;    } finally {&#10;      setSaving(false);&#10;    }&#10;  }&#10;&#10;  async function handleBannerUpload(e: React.ChangeEvent&lt;HTMLInputElement&gt;) {&#10;    const file = e.target.files?.[0];&#10;    if (!file) return;&#10;    setBannerMsg(null);&#10;    setBannerUploading(true);&#10;    try {&#10;      const fd = new FormData();&#10;      fd.append('file', file);&#10;      const res = await fetch('/api/account/banner', { method: 'POST', body: fd });&#10;      const data = await res.json();&#10;      if (!res.ok) throw new Error(data?.error || 'Upload fehlgeschlagen');&#10;      setBannerUrl(data.url);&#10;      setBannerMsg('Banner aktualisiert. Nicht vergessen zu speichern.');&#10;    } catch (err: unknown) {&#10;      const msg = err instanceof Error ? err.message : 'Upload fehlgeschlagen';&#10;      setBannerMsg(msg);&#10;    } finally {&#10;      setBannerUploading(false);&#10;    }&#10;  }&#10;&#10;  async function handleRemove() {&#10;    if (!avatarUrl) return;&#10;    setRemoving(true);&#10;    setMessage(null);&#10;    try {&#10;      const res = await fetch('/api/account/profile', {&#10;        method: 'POST',&#10;        headers: { 'Content-Type': 'application/json' },&#10;        body: JSON.stringify({ bio, avatar_url: null })&#10;      });&#10;      const data = await res.json();&#10;      if (!res.ok) throw new Error(data?.error || 'Entfernen fehlgeschlagen');&#10;      setAvatarUrl(null);&#10;      setMessage('Profilbild entfernt.');&#10;    } catch (err: unknown) {&#10;      const msg = err instanceof Error ? err.message : 'Entfernen fehlgeschlagen';&#10;      setMessage(msg);&#10;    } finally {&#10;      setRemoving(false);&#10;    }&#10;  }&#10;&#10;  return (&#10;    &lt;form onSubmit={handleSave} className=&quot;space-y-6&quot;&gt;&#10;      {/* Banner */}&#10;      &lt;div className=&quot;space-y-3&quot;&gt;&#10;        &lt;label className=&quot;block text-sm font-medium text-[#f5f1ed]&quot;&gt;Profil-Banner&lt;/label&gt;&#10;        &lt;div className=&quot;rounded-xl overflow-hidden bg-[#38302b] border border-[#e89a7a]/20&quot;&gt;&#10;          {bannerUrl ? (&#10;            &lt;BannerImage&#10;              src={withBasePath(bannerUrl)}&#10;              alt=&quot;Banner&quot;&#10;              className=&quot;w-full h-40 object-cover&quot;&#10;            /&gt;&#10;          ) : (&#10;            &lt;div className=&quot;w-full h-40 flex items-center justify-center text-[#b8aea5] text-sm&quot;&gt;&#10;              Kein Banner&#10;            &lt;/div&gt;&#10;          )}&#10;        &lt;/div&gt;&#10;        &lt;div className=&quot;flex items-center gap-3&quot;&gt;&#10;          &lt;input type=&quot;file&quot; accept=&quot;image/*&quot; onChange={handleBannerUpload} className=&quot;block text-sm text-[#b8aea5] file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-[#e89a7a]/20 file:text-[#e89a7a] hover:file:bg-[#e89a7a]/30&quot; /&gt;&#10;          {bannerUrl &amp;&amp; (&#10;            &lt;GlowButton type=&quot;button&quot; variant=&quot;secondary&quot; onClick={() =&gt; { setBannerUrl(null); setBannerMsg('Banner entfernt. Nicht vergessen zu speichern.'); }} loading={bannerUploading}&gt;&#10;              Banner entfernen&#10;            &lt;/GlowButton&gt;&#10;          )}&#10;        &lt;/div&gt;&#10;        &lt;p className=&quot;text-xs text-[#8faf9d]&quot;&gt;Erlaubte Formate: JPG, PNG, WEBP, GIF. Max 10MB.&lt;/p&gt;&#10;        {bannerMsg &amp;&amp; &lt;div className=&quot;text-xs text-[#e89a7a]&quot;&gt;{bannerMsg}&lt;/div&gt;}&#10;      &lt;/div&gt;&#10;&#10;      {/* Avatar */}&#10;      &lt;div className=&quot;flex items-start gap-6&quot;&gt;&#10;        &lt;div className=&quot;w-24 h-24 rounded-xl overflow-hidden bg-[#38302b] flex items-center justify-center border border-[#e89a7a]/20&quot;&gt;&#10;          {avatarUrl ? (&#10;            &lt;AvatarImage&#10;              src={avatarUrl}&#10;              alt=&quot;Avatar&quot;&#10;              className=&quot;w-full h-full&quot;&#10;            /&gt;&#10;          ) : (&#10;            &lt;span className=&quot;text-[#b8aea5] text-sm&quot;&gt;Kein Bild&lt;/span&gt;&#10;          )}&#10;        &lt;/div&gt;&#10;        &lt;div&gt;&#10;          &lt;label className=&quot;block text-sm font-medium text-[#f5f1ed] mb-2&quot;&gt;Profilbild&lt;/label&gt;&#10;          &lt;input type=&quot;file&quot; accept=&quot;image/*&quot; onChange={handleUpload} className=&quot;block text-sm text-[#b8aea5] file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-[#e89a7a]/20 file:text-[#e89a7a] hover:file:bg-[#e89a7a]/30&quot; /&gt;&#10;          &lt;p className=&quot;text-xs text-[#8faf9d] mt-2&quot;&gt;Erlaubte Formate: JPG, PNG, WEBP, GIF. Max 5MB.&lt;/p&gt;&#10;        &lt;/div&gt;&#10;      &lt;/div&gt;&#10;&#10;      &lt;div&gt;&#10;        &lt;label className=&quot;block text-sm font-medium text-[#f5f1ed] mb-2&quot;&gt;Bio&lt;/label&gt;&#10;        &lt;textarea&#10;          value={bio}&#10;          onChange={(e) =&gt; setBio(e.target.value)}&#10;          rows={5}&#10;          className=&quot;w-full rounded-lg bg-[#2a2520] border border-[#e89a7a]/20 p-3 text-sm text-[#f5f1ed] placeholder-[#b8aea5] focus:outline-none focus:ring-2 focus:ring-[#e89a7a]/40&quot;&#10;          placeholder=&quot;Erzähle kurz etwas über dich...&quot;&#10;        /&gt;&#10;        &lt;div className=&quot;text-xs text-[#b8aea5] mt-1&quot;&gt;{bio.length}/2000&lt;/div&gt;&#10;      &lt;/div&gt;&#10;&#10;      {message &amp;&amp; &lt;div className=&quot;text-sm text-[#e89a7a]&quot;&gt;{message}&lt;/div&gt;}&#10;&#10;      &lt;div className=&quot;flex gap-3&quot;&gt;&#10;        &lt;GlowButton type=&quot;submit&quot; loading={saving}&gt;&#10;          Speichern&#10;        &lt;/GlowButton&gt;&#10;        {avatarUrl &amp;&amp; (&#10;          &lt;GlowButton type=&quot;button&quot; variant=&quot;secondary&quot; onClick={handleRemove} loading={removing}&gt;&#10;            Bild entfernen&#10;          &lt;/GlowButton&gt;&#10;        )}&#10;      &lt;/div&gt;&#10;    &lt;/form&gt;&#10;  );&#10;}&#10;" />
            </PendingDiffInfo>
          </value>
        </entry>
        <entry key="$PROJECT_DIR$/app/admin/user/page.tsx">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/app/admin/user/page.tsx" />
              <option name="originalContent" value="import { redirect } from &quot;next/navigation&quot;;&#10;import { getSession } from &quot;@/lib/session&quot;;&#10;import { query } from &quot;@/lib/db&quot;;&#10;import GlassCard from &quot;@/components/ui/GlassCard&quot;;&#10;import GlowButton from &quot;@/components/ui/GlowButton&quot;;&#10;import LoginLinkClient from &quot;./LoginLinkClient&quot;;&#10;import ResetPollClient from &quot;./ResetPollClient&quot;;&#10;import UserListClient from &quot;./UserListClient&quot;;&#10;import ClassPdfGenerator from &quot;./ClassPdfGenerator&quot;;&#10;import NewUserForm from &quot;./NewUserForm&quot;;&#10;import { createUserAction, deleteUserAction, updateUserPasswordAction, updateUserRoleAction, banUserAction, unbanUserAction, banIpAction, unbanIpAction } from &quot;../actions&quot;;&#10;import { Users, Shield, KeyRound, UserPlus, Trash2, QrCode, Ban, ArrowLeft, CheckCircle2, FileDown } from &quot;lucide-react&quot;;&#10;import { ensureUserClassColumn, ensurePollSubmissionsTable } from &quot;@/lib/migrations&quot;;&#10;import { CLASSES } from &quot;@/lib/constants&quot;;&#10;&#10;export const dynamic = &quot;force-dynamic&quot;;&#10;&#10;type UserRow = { id: number; username: string; role: &quot;user&quot; | &quot;moderator&quot; | &quot;admin&quot;; class: string | null; has_voted: number };&#10;&#10;export default async function AdminUserPage({ searchParams }: { searchParams: Promise&lt;{ [key: string]: string | string[] | undefined }&gt; }) {&#10;  const session = await getSession();&#10;  if (!session) redirect(&quot;/login&quot;);&#10;  if (session.role !== &quot;admin&quot;) redirect(&quot;/zugriff-verweigert&quot;);&#10;&#10;  await ensureUserClassColumn();&#10;  await ensurePollSubmissionsTable();&#10;&#10;  const sp = await searchParams;&#10;  const q = typeof sp?.q === &quot;string&quot; ? sp.q.trim() : &quot;&quot;;&#10;  const classFilter = typeof sp?.class === &quot;string&quot; ? sp.class.trim() : &quot;&quot;;&#10;&#10;  const where: string[] = [];&#10;  const params: string[] = [];&#10;  if (q) { where.push(&quot;u.username LIKE ?&quot;); params.push(`%${q}%`); }&#10;  if (classFilter === &quot;none&quot;) { where.push(&quot;u.class IS NULL&quot;); }&#10;  else if (classFilter) { where.push(&quot;u.class = ?&quot;); params.push(classFilter); }&#10;  const whereSql = where.length ? `WHERE ${where.join(&quot; AND &quot;)}` : &quot;&quot;;&#10;&#10;  const users = await query&lt;UserRow[]&gt;(&#10;    `SELECT u.id, u.username, u.role, u.class, &#10;     COALESCE((SELECT 1 FROM poll_submissions ps WHERE ps.user_id = u.id LIMIT 1), 0) as has_voted&#10;     FROM users u ${whereSql} ORDER BY u.id DESC`,&#10;    params&#10;  );&#10;&#10;  const stats = {&#10;    total: users.length,&#10;    admins: users.filter((u) =&gt; u.role === 'admin').length,&#10;    moderators: users.filter((u) =&gt; u.role === 'moderator').length,&#10;    users: users.filter((u) =&gt; u.role === 'user').length,&#10;  };&#10;&#10;  const groups = [&#10;    { label: 'Ohne Klasse', items: users.filter((u) =&gt; !u.class) },&#10;    ...CLASSES.map((c) =&gt; ({ label: c, items: users.filter((u) =&gt; u.class === c) })),&#10;  ];&#10;&#10;  return (&#10;    &lt;div className=&quot;relative min-h-dvh overflow-hidden bg-gradient-to-br from-[#1a1714] via-[#221e1a] to-[#1a1714]&quot;&gt;&#10;      &lt;div className=&quot;hidden md:block pointer-events-none absolute inset-0 -z-10&quot;&gt;&#10;        &lt;div className=&quot;absolute -top-40 -left-40 h-[520px] w-[520px] rounded-full bg-[#e89a7a]/6 blur-3xl&quot; /&gt;&#10;        &lt;div className=&quot;absolute top-1/3 -right-32 h-[420px] w-[420px] rounded-full bg-[#8faf9d]/6 blur-3xl&quot; /&gt;&#10;      &lt;/div&gt;&#10;&#10;      &lt;div className=&quot;max-w-7xl mx-auto px-4 py-12 space-y-10&quot;&gt;&#10;        &lt;div className=&quot;text-center mb-12&quot;&gt;&#10;          &lt;div className=&quot;inline-flex items-center gap-2 mb-4 px-4 py-2 rounded-full bg-[#e89a7a]/10 border border-[#e89a7a]/20&quot;&gt;&#10;            &lt;Shield className=&quot;h-4 w-4 text-[#e89a7a]&quot; /&gt;&#10;            &lt;span className=&quot;text-xs font-medium tracking-wide uppercase text-[#e89a7a]&quot;&gt;&#10;              Nur für Admins&#10;            &lt;/span&gt;&#10;          &lt;/div&gt;&#10;          &lt;h1 className=&quot;text-4xl sm:text-5xl font-bold text-[#f5f1ed] mb-4&quot;&gt;&#10;            Benutzerverwaltung&#10;          &lt;/h1&gt;&#10;          &lt;p className=&quot;text-lg text-[#b8aea5] max-w-2xl mx-auto&quot;&gt;&#10;            Alle Account-Werkzeuge an einem Ort – schön, klar, schnell.&#10;          &lt;/p&gt;&#10;        &lt;/div&gt;&#10;&#10;        {/* PDF Generator */}&#10;        &lt;GlassCard&#10;          header={&#10;            &lt;div className=&quot;flex items-center gap-3&quot;&gt;&#10;              &lt;span className=&quot;inline-flex h-10 w-10 items-center justify-center rounded-xl bg-[#8faf9d]/10 text-[#8faf9d]&quot;&gt;&#10;                &lt;FileDown className=&quot;h-5 w-5&quot;/&gt;&#10;              &lt;/span&gt;&#10;              &lt;div&gt;&#10;                &lt;h3 className=&quot;text-lg font-semibold text-[#f5f1ed]&quot;&gt;Login-Daten als PDF&lt;/h3&gt;&#10;                &lt;p className=&quot;text-sm text-[#b8aea5]&quot;&gt;Erstelle eine übersichtliche PDF-Liste für eine Klasse zum Verteilen.&lt;/p&gt;&#10;              &lt;/div&gt;&#10;            &lt;/div&gt;&#10;          }&#10;        &gt;&#10;          &lt;ClassPdfGenerator /&gt;&#10;        &lt;/GlassCard&gt;&#10;&#10;        {/* Quick stats */}&#10;        &lt;div className=&quot;grid gap-6 sm:grid-cols-2 lg:grid-cols-4&quot;&gt;&#10;          {[&#10;            {label:'Gesamt',value:stats.total,icon:&lt;Users className='h-5 w-5'/&gt;, color: &quot;from-[#d97757] to-[#c96846]&quot;},&#10;            {label:'Admins',value:stats.admins,icon:&lt;Shield className='h-5 w-5'/&gt;, color: &quot;from-[#c96846] to-[#b85836]&quot;},&#10;            {label:'Moderatoren',value:stats.moderators,icon:&lt;KeyRound className='h-5 w-5'/&gt;, color: &quot;from-[#7a9b88] to-[#6a8b78]&quot;},&#10;            {label:'Users',value:stats.users,icon:&lt;Users className='h-5 w-5'/&gt;, color: &quot;from-[#b8957a] to-[#a88568]&quot;}&#10;          ].map((s,i)=&gt; (&#10;            &lt;GlassCard key={s.label} delay={i*0.05}&gt;&#10;              &lt;div className=&quot;flex items-center gap-4&quot;&gt;&#10;                &lt;div className={`h-12 w-12 rounded-2xl bg-gradient-to-br ${s.color} flex items-center justify-center text-white shadow-lg`}&gt;&#10;                  {s.icon}&#10;                &lt;/div&gt;&#10;                &lt;div&gt;&#10;                  &lt;div className=&quot;text-sm text-[#b8aea5]&quot;&gt;{s.label}&lt;/div&gt;&#10;                  &lt;div className=&quot;text-2xl font-bold text-[#f5f1ed]&quot;&gt;{s.value}&lt;/div&gt;&#10;                &lt;/div&gt;&#10;              &lt;/div&gt;&#10;            &lt;/GlassCard&gt;&#10;          ))}&#10;        &lt;/div&gt;&#10;&#10;        &lt;div className=&quot;grid lg:grid-cols-3 gap-8&quot;&gt;&#10;          {/* Left: Users list */}&#10;          &lt;div className=&quot;lg:col-span-2 space-y-8&quot;&gt;&#10;            &lt;GlassCard&#10;              header={&#10;                &lt;div className=&quot;flex items-center justify-between&quot;&gt;&#10;                  &lt;div className=&quot;flex items-center gap-3&quot;&gt;&#10;                    &lt;span className=&quot;inline-flex h-10 w-10 items-center justify-center rounded-xl bg-[#e89a7a]/10 text-[#e89a7a]&quot;&gt;&#10;                      &lt;Users className=&quot;h-5 w-5&quot;/&gt;&#10;                    &lt;/span&gt;&#10;                    &lt;div&gt;&#10;                      &lt;h3 className=&quot;text-lg font-semibold text-[#f5f1ed]&quot;&gt;Benutzer&lt;/h3&gt;&#10;                      &lt;p className=&quot;text-sm text-[#b8aea5]&quot;&gt;Rollen, Passwörter und Login-Links verwalten.&lt;/p&gt;&#10;                    &lt;/div&gt;&#10;                  &lt;/div&gt;&#10;                  &lt;a href=&quot;/admin&quot; className=&quot;text-sm text-[#e89a7a] hover:underline inline-flex items-center gap-1&quot;&gt;&#10;                    &lt;ArrowLeft className=&quot;h-3 w-3&quot; /&gt;&#10;                    Zurück&#10;                  &lt;/a&gt;&#10;                &lt;/div&gt;&#10;              }&#10;            &gt;&#10;              &lt;form method=&quot;GET&quot; className=&quot;mb-6 flex flex-wrap items-center gap-3&quot;&gt;&#10;                &lt;input type=&quot;text&quot; name=&quot;q&quot; defaultValue={q} placeholder=&quot;Suche Username&quot; className=&quot;input-base flex-1 min-w-[200px]&quot; /&gt;&#10;                &lt;select name=&quot;class&quot; defaultValue={classFilter} className=&quot;input-base min-w-[160px]&quot;&gt;&#10;                  &lt;option value=&quot;&quot;&gt;Alle Klassen&lt;/option&gt;&#10;                  &lt;option value=&quot;none&quot;&gt;Ohne Klasse&lt;/option&gt;&#10;                  {CLASSES.map((c) =&gt; (&#10;                    &lt;option key={c} value={c}&gt;{c}&lt;/option&gt;&#10;                  ))}&#10;                &lt;/select&gt;&#10;                &lt;GlowButton variant=&quot;primary&quot; className=&quot;px-5&quot;&gt;Filtern&lt;/GlowButton&gt;&#10;                &lt;a href=&quot;/admin/user&quot; className=&quot;text-sm text-[#e89a7a] hover:underline&quot;&gt;Zurücksetzen&lt;/a&gt;&#10;              &lt;/form&gt;&#10;&#10;              &lt;UserListClient users={users} /&gt;&#10;            &lt;/GlassCard&gt;&#10;          &lt;/div&gt;&#10;&#10;          {/* Right: Create + Ban */}&#10;          &lt;div className=&quot;lg:col-span-1 space-y-6&quot;&gt;&#10;            &lt;GlassCard&#10;              header={&#10;                &lt;div className=&quot;flex items-center gap-3&quot;&gt;&#10;                  &lt;span className=&quot;inline-flex h-10 w-10 items-center justify-center rounded-xl bg-[#8faf9d]/10 text-[#8faf9d]&quot;&gt;&#10;                    &lt;Users className=&quot;h-5 w-5&quot;/&gt;&#10;                  &lt;/span&gt;&#10;                  &lt;h3 className=&quot;text-lg font-semibold text-[#f5f1ed]&quot;&gt;Nach Klassen&lt;/h3&gt;&#10;                &lt;/div&gt;&#10;              }&#10;            &gt;&#10;              &lt;div className=&quot;space-y-3 max-h-[400px] overflow-y-auto&quot;&gt;&#10;                {groups.map((g) =&gt; (&#10;                  &lt;details key={g.label} className=&quot;rounded-xl border border-[#e89a7a]/10 bg-[#2a2520]/40 p-3 hover:border-[#e89a7a]/20 transition-all&quot;&gt;&#10;                    &lt;summary className=&quot;cursor-pointer select-none text-sm text-[#f5f1ed] flex items-center justify-between font-medium&quot;&gt;&#10;                      &lt;span&gt;{g.label}&lt;/span&gt;&#10;                      &lt;span className=&quot;text-xs text-[#b8aea5]&quot;&gt;{g.items.length}&lt;/span&gt;&#10;                    &lt;/summary&gt;&#10;                    {g.items.length === 0 ? (&#10;                      &lt;div className=&quot;mt-2 text-xs text-[#b8aea5]&quot;&gt;Keine Nutzer&lt;/div&gt;&#10;                    ) : (&#10;                      &lt;UserListClient users={g.items} /&gt;&#10;                    )}&#10;                  &lt;/details&gt;&#10;                ))}&#10;              &lt;/div&gt;&#10;            &lt;/GlassCard&gt;&#10;&#10;            &lt;GlassCard&#10;              header={&#10;                &lt;div className=&quot;flex items-center gap-3&quot;&gt;&#10;                  &lt;span className=&quot;inline-flex h-10 w-10 items-center justify-center rounded-xl bg-[#e89a7a]/10 text-[#e89a7a]&quot;&gt;&#10;                    &lt;UserPlus className=&quot;h-5 w-5&quot;/&gt;&#10;                  &lt;/span&gt;&#10;                  &lt;div&gt;&#10;                    &lt;h3 className=&quot;text-lg font-semibold text-[#f5f1ed]&quot;&gt;Benutzer anlegen&lt;/h3&gt;&#10;                    &lt;p className=&quot;text-sm text-[#b8aea5]&quot;&gt;Schnell einen Zugang erstellen.&lt;/p&gt;&#10;                  &lt;/div&gt;&#10;                &lt;/div&gt;&#10;              }&#10;            &gt;&#10;              &lt;NewUserForm /&gt;&#10;            &lt;/GlassCard&gt;&#10;&#10;            &lt;GlassCard&#10;              header={&#10;                &lt;div className=&quot;flex items-center gap-3&quot;&gt;&#10;                  &lt;span className=&quot;inline-flex h-10 w-10 items-center justify-center rounded-xl bg-[#d97757]/10 text-[#d97757]&quot;&gt;&#10;                    &lt;Ban className=&quot;h-5 w-5&quot;/&gt;&#10;                  &lt;/span&gt;&#10;                  &lt;div&gt;&#10;                    &lt;h3 className=&quot;text-lg font-semibold text-[#f5f1ed]&quot;&gt;Sperren&lt;/h3&gt;&#10;                    &lt;p className=&quot;text-sm text-[#b8aea5]&quot;&gt;User- und IP-Sperren verwalten.&lt;/p&gt;&#10;                  &lt;/div&gt;&#10;                &lt;/div&gt;&#10;              }&#10;            &gt;&#10;              &lt;div className=&quot;space-y-6&quot;&gt;&#10;                &lt;div&gt;&#10;                  &lt;div className=&quot;text-sm font-semibold mb-3 text-[#f5f1ed]&quot;&gt;Benutzer sperren&lt;/div&gt;&#10;                  &lt;form action={banUserAction} className=&quot;space-y-3&quot;&gt;&#10;                    &lt;input name=&quot;user_id&quot; placeholder=&quot;User ID&quot; className=&quot;input-base&quot; /&gt;&#10;                    &lt;input name=&quot;reason&quot; placeholder=&quot;Grund (optional)&quot; className=&quot;input-base&quot; /&gt;&#10;                    &lt;input name=&quot;expires_at&quot; type=&quot;datetime-local&quot; className=&quot;input-base&quot; /&gt;&#10;                    &lt;GlowButton variant=&quot;primary&quot; className=&quot;w-full&quot;&gt;Sperren&lt;/GlowButton&gt;&#10;                  &lt;/form&gt;&#10;                  &lt;form action={unbanUserAction} className=&quot;flex items-center gap-2 mt-3&quot;&gt;&#10;                    &lt;input name=&quot;user_id&quot; placeholder=&quot;User ID&quot; className=&quot;input-base flex-1&quot; /&gt;&#10;                    &lt;GlowButton variant=&quot;secondary&quot; className=&quot;px-4&quot;&gt;Entsperren&lt;/GlowButton&gt;&#10;                  &lt;/form&gt;&#10;                &lt;/div&gt;&#10;                &lt;div className=&quot;pt-3 border-t border-[#e89a7a]/10&quot;&gt;&#10;                  &lt;div className=&quot;text-sm font-semibold mb-3 text-[#f5f1ed]&quot;&gt;IP sperren&lt;/div&gt;&#10;                  &lt;form action={banIpAction} className=&quot;space-y-3&quot;&gt;&#10;                    &lt;input name=&quot;ip&quot; placeholder=&quot;IP-Adresse&quot; className=&quot;input-base&quot; /&gt;&#10;                    &lt;input name=&quot;reason&quot; placeholder=&quot;Grund (optional)&quot; className=&quot;input-base&quot; /&gt;&#10;                    &lt;input name=&quot;expires_at&quot; type=&quot;datetime-local&quot; className=&quot;input-base&quot; /&gt;&#10;                    &lt;GlowButton variant=&quot;primary&quot; className=&quot;w-full&quot;&gt;Sperren&lt;/GlowButton&gt;&#10;                  &lt;/form&gt;&#10;                  &lt;form action={unbanIpAction} className=&quot;flex items-center gap-2 mt-3&quot;&gt;&#10;                    &lt;input name=&quot;ip&quot; placeholder=&quot;IP-Adresse&quot; className=&quot;input-base flex-1&quot; /&gt;&#10;                    &lt;GlowButton variant=&quot;secondary&quot; className=&quot;px-4&quot;&gt;Entsperren&lt;/GlowButton&gt;&#10;                  &lt;/form&gt;&#10;                &lt;/div&gt;&#10;              &lt;/div&gt;&#10;            &lt;/GlassCard&gt;&#10;          &lt;/div&gt;&#10;        &lt;/div&gt;&#10;      &lt;/div&gt;&#10;    &lt;/div&gt;&#10;  );&#10;}&#10;" />
              <option name="updatedContent" value="import { redirect } from &quot;next/navigation&quot;;&#10;import { getSession } from &quot;@/lib/session&quot;;&#10;import { query } from &quot;@/lib/db&quot;;&#10;import GlassCard from &quot;@/components/ui/GlassCard&quot;;&#10;import GlowButton from &quot;@/components/ui/GlowButton&quot;;&#10;import LoginLinkClient from &quot;./LoginLinkClient&quot;;&#10;import ResetPollClient from &quot;./ResetPollClient&quot;;&#10;import UserListClient from &quot;./UserListClient&quot;;&#10;import ClassPdfGenerator from &quot;./ClassPdfGenerator&quot;;&#10;import NewUserForm from &quot;./NewUserForm&quot;;&#10;import { createUserAction, deleteUserAction, updateUserPasswordAction, updateUserRoleAction, banUserAction, unbanUserAction, banIpAction, unbanIpAction } from &quot;../actions&quot;;&#10;import { Users, Shield, KeyRound, UserPlus, Trash2, QrCode, Ban, ArrowLeft, CheckCircle2, FileDown } from &quot;lucide-react&quot;;&#10;import { ensureUserClassColumn, ensurePollSubmissionsTable } from &quot;@/lib/migrations&quot;;&#10;import { CLASSES } from &quot;@/lib/constants&quot;;&#10;&#10;export const dynamic = &quot;force-dynamic&quot;;&#10;&#10;type UserRow = { id: number; username: string; role: &quot;user&quot; | &quot;moderator&quot; | &quot;admin&quot;; class: string | null; has_voted: number };&#10;&#10;export default async function AdminUserPage({ searchParams }: { searchParams: Promise&lt;{ [key: string]: string | string[] | undefined }&gt; }) {&#10;  const session = await getSession();&#10;  if (!session) redirect(&quot;/login&quot;);&#10;  if (session.role !== &quot;admin&quot;) redirect(&quot;/zugriff-verweigert&quot;);&#10;&#10;  await ensureUserClassColumn();&#10;  await ensurePollSubmissionsTable();&#10;&#10;  const sp = await searchParams;&#10;  const q = typeof sp?.q === &quot;string&quot; ? sp.q.trim() : &quot;&quot;;&#10;  const classFilter = typeof sp?.class === &quot;string&quot; ? sp.class.trim() : &quot;&quot;;&#10;&#10;  const where: string[] = [];&#10;  const params: string[] = [];&#10;  if (q) { where.push(&quot;u.username LIKE ?&quot;); params.push(`%${q}%`); }&#10;  if (classFilter === &quot;none&quot;) { where.push(&quot;u.class IS NULL&quot;); }&#10;  else if (classFilter) { where.push(&quot;u.class = ?&quot;); params.push(classFilter); }&#10;  const whereSql = where.length ? `WHERE ${where.join(&quot; AND &quot;)}` : &quot;&quot;;&#10;&#10;  const users = await query&lt;UserRow[]&gt;(&#10;    `SELECT u.id, u.username, u.role, u.class, &#10;     COALESCE((SELECT 1 FROM poll_submissions ps WHERE ps.user_id = u.id LIMIT 1), 0) as has_voted&#10;     FROM users u ${whereSql} ORDER BY u.id DESC`,&#10;    params&#10;  );&#10;&#10;  const stats = {&#10;    total: users.length,&#10;    admins: users.filter((u) =&gt; u.role === 'admin').length,&#10;    moderators: users.filter((u) =&gt; u.role === 'moderator').length,&#10;    users: users.filter((u) =&gt; u.role === 'user').length,&#10;  };&#10;&#10;  const groups = [&#10;    { label: 'Ohne Klasse', items: users.filter((u) =&gt; !u.class) },&#10;    ...CLASSES.map((c) =&gt; ({ label: c, items: users.filter((u) =&gt; u.class === c) })),&#10;  ];&#10;&#10;  return (&#10;    &lt;div className=&quot;relative min-h-dvh overflow-hidden bg-gradient-to-br from-[#1a1714] via-[#221e1a] to-[#1a1714]&quot;&gt;&#10;      &lt;div className=&quot;hidden md:block pointer-events-none absolute inset-0 -z-10&quot;&gt;&#10;        &lt;div className=&quot;absolute -top-40 -left-40 h-[520px] w-[520px] rounded-full bg-[#e89a7a]/6 blur-3xl&quot; /&gt;&#10;        &lt;div className=&quot;absolute top-1/3 -right-32 h-[420px] w-[420px] rounded-full bg-[#8faf9d]/6 blur-3xl&quot; /&gt;&#10;      &lt;/div&gt;&#10;&#10;      &lt;div className=&quot;max-w-6xl mx-auto px-4 py-12 space-y-10&quot;&gt;&#10;        &lt;div className=&quot;text-center mb-12&quot;&gt;&#10;          &lt;div className=&quot;inline-flex items-center gap-2 mb-4 px-4 py-2 rounded-full bg-[#e89a7a]/10 border border-[#e89a7a]/20&quot;&gt;&#10;            &lt;Shield className=&quot;h-4 w-4 text-[#e89a7a]&quot; /&gt;&#10;            &lt;span className=&quot;text-xs font-medium tracking-wide uppercase text-[#e89a7a]&quot;&gt;&#10;              Nur für Admins&#10;            &lt;/span&gt;&#10;          &lt;/div&gt;&#10;          &lt;h1 className=&quot;text-4xl sm:text-5xl font-bold text-[#f5f1ed] mb-4&quot;&gt;&#10;            Benutzerverwaltung&#10;          &lt;/h1&gt;&#10;          &lt;p className=&quot;text-lg text-[#b8aea5] max-w-2xl mx-auto&quot;&gt;&#10;            Alle Account-Werkzeuge an einem Ort – schön, klar, schnell.&#10;          &lt;/p&gt;&#10;        &lt;/div&gt;&#10;&#10;        {/* PDF Generator */}&#10;        &lt;GlassCard&#10;          header={&#10;            &lt;div className=&quot;flex items-center gap-3&quot;&gt;&#10;              &lt;span className=&quot;inline-flex h-10 w-10 items-center justify-center rounded-xl bg-[#8faf9d]/10 text-[#8faf9d]&quot;&gt;&#10;                &lt;FileDown className=&quot;h-5 w-5&quot;/&gt;&#10;              &lt;/span&gt;&#10;              &lt;div&gt;&#10;                &lt;h3 className=&quot;text-lg font-semibold text-[#f5f1ed]&quot;&gt;Login-Daten als PDF&lt;/h3&gt;&#10;                &lt;p className=&quot;text-sm text-[#b8aea5]&quot;&gt;Erstelle eine übersichtliche PDF-Liste für eine Klasse zum Verteilen.&lt;/p&gt;&#10;              &lt;/div&gt;&#10;            &lt;/div&gt;&#10;          }&#10;        &gt;&#10;          &lt;ClassPdfGenerator /&gt;&#10;        &lt;/GlassCard&gt;&#10;&#10;        {/* Quick stats */}&#10;        &lt;div className=&quot;grid gap-6 sm:grid-cols-2 lg:grid-cols-4&quot;&gt;&#10;          {[&#10;            {label:'Gesamt',value:stats.total,icon:&lt;Users className='h-5 w-5'/&gt;, color: &quot;from-[#d97757] to-[#c96846]&quot;},&#10;            {label:'Admins',value:stats.admins,icon:&lt;Shield className='h-5 w-5'/&gt;, color: &quot;from-[#c96846] to-[#b85836]&quot;},&#10;            {label:'Moderatoren',value:stats.moderators,icon:&lt;KeyRound className='h-5 w-5'/&gt;, color: &quot;from-[#7a9b88] to-[#6a8b78]&quot;},&#10;            {label:'Users',value:stats.users,icon:&lt;Users className='h-5 w-5'/&gt;, color: &quot;from-[#b8957a] to-[#a88568]&quot;}&#10;          ].map((s,i)=&gt; (&#10;            &lt;GlassCard key={s.label} delay={i*0.05}&gt;&#10;              &lt;div className=&quot;flex items-center gap-4&quot;&gt;&#10;                &lt;div className={`h-12 w-12 rounded-2xl bg-gradient-to-br ${s.color} flex items-center justify-center text-white shadow-lg`}&gt;&#10;                  {s.icon}&#10;                &lt;/div&gt;&#10;                &lt;div&gt;&#10;                  &lt;div className=&quot;text-sm text-[#b8aea5]&quot;&gt;{s.label}&lt;/div&gt;&#10;                  &lt;div className=&quot;text-2xl font-bold text-[#f5f1ed]&quot;&gt;{s.value}&lt;/div&gt;&#10;                &lt;/div&gt;&#10;              &lt;/div&gt;&#10;            &lt;/GlassCard&gt;&#10;          ))}&#10;        &lt;/div&gt;&#10;&#10;        &lt;div className=&quot;grid lg:grid-cols-3 gap-6 lg:gap-8&quot;&gt;&#10;          {/* Left: Users list */}&#10;          &lt;div className=&quot;lg:col-span-2 space-y-6 lg:space-y-8 min-w-0&quot;&gt;&#10;            &lt;GlassCard&#10;              header={&#10;                &lt;div className=&quot;flex flex-col sm:flex-row items-start sm:items-center justify-between gap-3&quot;&gt;&#10;                  &lt;div className=&quot;flex items-center gap-3&quot;&gt;&#10;                    &lt;span className=&quot;inline-flex h-10 w-10 items-center justify-center rounded-xl bg-[#e89a7a]/10 text-[#e89a7a]&quot;&gt;&#10;                      &lt;Users className=&quot;h-5 w-5&quot;/&gt;&#10;                    &lt;/span&gt;&#10;                    &lt;div&gt;&#10;                      &lt;h3 className=&quot;text-lg font-semibold text-[#f5f1ed]&quot;&gt;Benutzer&lt;/h3&gt;&#10;                      &lt;p className=&quot;text-sm text-[#b8aea5]&quot;&gt;Rollen, Passwörter und Login-Links verwalten.&lt;/p&gt;&#10;                    &lt;/div&gt;&#10;                  &lt;/div&gt;&#10;                  &lt;a href=&quot;/admin&quot; className=&quot;text-sm text-[#e89a7a] hover:underline inline-flex items-center gap-1 whitespace-nowrap&quot;&gt;&#10;                    &lt;ArrowLeft className=&quot;h-3 w-3&quot; /&gt;&#10;                    Zurück&#10;                  &lt;/a&gt;&#10;                &lt;/div&gt;&#10;              }&#10;            &gt;&#10;              &lt;form method=&quot;GET&quot; className=&quot;mb-6 flex flex-col sm:flex-row flex-wrap items-stretch sm:items-center gap-3&quot;&gt;&#10;                &lt;input type=&quot;text&quot; name=&quot;q&quot; defaultValue={q} placeholder=&quot;Suche Username&quot; className=&quot;input-base flex-1 min-w-[180px]&quot; /&gt;&#10;                &lt;select name=&quot;class&quot; defaultValue={classFilter} className=&quot;input-base sm:min-w-[140px]&quot;&gt;&#10;                  &lt;option value=&quot;&quot;&gt;Alle Klassen&lt;/option&gt;&#10;                  &lt;option value=&quot;none&quot;&gt;Ohne Klasse&lt;/option&gt;&#10;                  {CLASSES.map((c) =&gt; (&#10;                    &lt;option key={c} value={c}&gt;{c}&lt;/option&gt;&#10;                  ))}&#10;                &lt;/select&gt;&#10;                &lt;GlowButton variant=&quot;primary&quot; className=&quot;px-5 whitespace-nowrap&quot;&gt;Filtern&lt;/GlowButton&gt;&#10;                &lt;a href=&quot;/admin/user&quot; className=&quot;text-sm text-[#e89a7a] hover:underline whitespace-nowrap&quot;&gt;Zurücksetzen&lt;/a&gt;&#10;              &lt;/form&gt;&#10;&#10;              &lt;UserListClient users={users} /&gt;&#10;            &lt;/GlassCard&gt;&#10;          &lt;/div&gt;&#10;&#10;          {/* Right: Create + Ban */}&#10;          &lt;div className=&quot;lg:col-span-1 space-y-6 min-w-0&quot;&gt;&#10;            &lt;GlassCard&#10;              header={&#10;                &lt;div className=&quot;flex items-center gap-3&quot;&gt;&#10;                  &lt;span className=&quot;inline-flex h-10 w-10 items-center justify-center rounded-xl bg-[#8faf9d]/10 text-[#8faf9d]&quot;&gt;&#10;                    &lt;Users className=&quot;h-5 w-5&quot;/&gt;&#10;                  &lt;/span&gt;&#10;                  &lt;h3 className=&quot;text-lg font-semibold text-[#f5f1ed]&quot;&gt;Nach Klassen&lt;/h3&gt;&#10;                &lt;/div&gt;&#10;              }&#10;            &gt;&#10;              &lt;div className=&quot;space-y-2 max-h-[400px] overflow-y-auto overflow-x-hidden&quot;&gt;&#10;                {groups.map((g) =&gt; (&#10;                  &lt;details key={g.label} className=&quot;rounded-xl border border-[#e89a7a]/10 bg-[#2a2520]/40 p-2 hover:border-[#e89a7a]/20 transition-all&quot;&gt;&#10;                    &lt;summary className=&quot;cursor-pointer select-none text-sm text-[#f5f1ed] flex items-center justify-between font-medium&quot;&gt;&#10;                      &lt;span className=&quot;truncate&quot;&gt;{g.label}&lt;/span&gt;&#10;                      &lt;span className=&quot;text-xs text-[#b8aea5] ml-2 shrink-0&quot;&gt;{g.items.length}&lt;/span&gt;&#10;                    &lt;/summary&gt;&#10;                    {g.items.length === 0 ? (&#10;                      &lt;div className=&quot;mt-2 text-xs text-[#b8aea5]&quot;&gt;Keine Nutzer&lt;/div&gt;&#10;                    ) : (&#10;                      &lt;div className=&quot;mt-2&quot;&gt;&#10;                        &lt;UserListClient users={g.items} compact={true} /&gt;&#10;                      &lt;/div&gt;&#10;                    )}&#10;                  &lt;/details&gt;&#10;                ))}&#10;              &lt;/div&gt;&#10;            &lt;/GlassCard&gt;&#10;&#10;            &lt;GlassCard&#10;              header={&#10;                &lt;div className=&quot;flex items-center gap-3&quot;&gt;&#10;                  &lt;span className=&quot;inline-flex h-10 w-10 items-center justify-center rounded-xl bg-[#e89a7a]/10 text-[#e89a7a]&quot;&gt;&#10;                    &lt;UserPlus className=&quot;h-5 w-5&quot;/&gt;&#10;                  &lt;/span&gt;&#10;                  &lt;div&gt;&#10;                    &lt;h3 className=&quot;text-lg font-semibold text-[#f5f1ed]&quot;&gt;Benutzer anlegen&lt;/h3&gt;&#10;                    &lt;p className=&quot;text-sm text-[#b8aea5]&quot;&gt;Schnell einen Zugang erstellen.&lt;/p&gt;&#10;                  &lt;/div&gt;&#10;                &lt;/div&gt;&#10;              }&#10;            &gt;&#10;              &lt;NewUserForm /&gt;&#10;            &lt;/GlassCard&gt;&#10;&#10;            &lt;GlassCard&#10;              header={&#10;                &lt;div className=&quot;flex items-center gap-3&quot;&gt;&#10;                  &lt;span className=&quot;inline-flex h-10 w-10 items-center justify-center rounded-xl bg-[#d97757]/10 text-[#d97757]&quot;&gt;&#10;                    &lt;Ban className=&quot;h-5 w-5&quot;/&gt;&#10;                  &lt;/span&gt;&#10;                  &lt;div&gt;&#10;                    &lt;h3 className=&quot;text-lg font-semibold text-[#f5f1ed]&quot;&gt;Sperren&lt;/h3&gt;&#10;                    &lt;p className=&quot;text-sm text-[#b8aea5]&quot;&gt;User- und IP-Sperren verwalten.&lt;/p&gt;&#10;                  &lt;/div&gt;&#10;                &lt;/div&gt;&#10;              }&#10;            &gt;&#10;              &lt;div className=&quot;space-y-6&quot;&gt;&#10;                &lt;div&gt;&#10;                  &lt;div className=&quot;text-sm font-semibold mb-3 text-[#f5f1ed]&quot;&gt;Benutzer sperren&lt;/div&gt;&#10;                  &lt;form action={banUserAction} className=&quot;space-y-3&quot;&gt;&#10;                    &lt;input name=&quot;user_id&quot; placeholder=&quot;User ID&quot; className=&quot;input-base w-full&quot; /&gt;&#10;                    &lt;input name=&quot;reason&quot; placeholder=&quot;Grund (optional)&quot; className=&quot;input-base w-full&quot; /&gt;&#10;                    &lt;input name=&quot;expires_at&quot; type=&quot;datetime-local&quot; className=&quot;input-base w-full&quot; /&gt;&#10;                    &lt;GlowButton variant=&quot;primary&quot; className=&quot;w-full&quot;&gt;Sperren&lt;/GlowButton&gt;&#10;                  &lt;/form&gt;&#10;                  &lt;form action={unbanUserAction} className=&quot;flex flex-col sm:flex-row items-stretch sm:items-center gap-2 mt-3&quot;&gt;&#10;                    &lt;input name=&quot;user_id&quot; placeholder=&quot;User ID&quot; className=&quot;input-base flex-1&quot; /&gt;&#10;                    &lt;GlowButton variant=&quot;secondary&quot; className=&quot;px-4 whitespace-nowrap&quot;&gt;Entsperren&lt;/GlowButton&gt;&#10;                  &lt;/form&gt;&#10;                &lt;/div&gt;&#10;                &lt;div className=&quot;pt-3 border-t border-[#e89a7a]/10&quot;&gt;&#10;                  &lt;div className=&quot;text-sm font-semibold mb-3 text-[#f5f1ed]&quot;&gt;IP sperren&lt;/div&gt;&#10;                  &lt;form action={banIpAction} className=&quot;space-y-3&quot;&gt;&#10;                    &lt;input name=&quot;ip&quot; placeholder=&quot;IP-Adresse&quot; className=&quot;input-base w-full&quot; /&gt;&#10;                    &lt;input name=&quot;reason&quot; placeholder=&quot;Grund (optional)&quot; className=&quot;input-base w-full&quot; /&gt;&#10;                    &lt;input name=&quot;expires_at&quot; type=&quot;datetime-local&quot; className=&quot;input-base w-full&quot; /&gt;&#10;                    &lt;GlowButton variant=&quot;primary&quot; className=&quot;w-full&quot;&gt;Sperren&lt;/GlowButton&gt;&#10;                  &lt;/form&gt;&#10;                  &lt;form action={unbanIpAction} className=&quot;flex flex-col sm:flex-row items-stretch sm:items-center gap-2 mt-3&quot;&gt;&#10;                    &lt;input name=&quot;ip&quot; placeholder=&quot;IP-Adresse&quot; className=&quot;input-base flex-1&quot; /&gt;&#10;                    &lt;GlowButton variant=&quot;secondary&quot; className=&quot;px-4 whitespace-nowrap&quot;&gt;Entsperren&lt;/GlowButton&gt;&#10;                  &lt;/form&gt;&#10;                &lt;/div&gt;&#10;              &lt;/div&gt;&#10;            &lt;/GlassCard&gt;&#10;          &lt;/div&gt;&#10;        &lt;/div&gt;&#10;      &lt;/div&gt;&#10;    &lt;/div&gt;&#10;  );&#10;}&#10;" />
            </PendingDiffInfo>
          </value>
        </entry>
        <entry key="$PROJECT_DIR$/components/AvatarImage.tsx">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/components/AvatarImage.tsx" />
              <option name="updatedContent" value="&quot;use client&quot;;&#10;&#10;import { BookOpen } from &quot;lucide-react&quot;;&#10;&#10;type AvatarImageProps = {&#10;  src: string | null;&#10;  alt: string;&#10;  className?: string;&#10;  fallbackIcon?: React.ReactNode;&#10;};&#10;&#10;export default function AvatarImage({ src, alt, className = &quot;&quot;, fallbackIcon }: AvatarImageProps) {&#10;  if (!src) {&#10;    return (&#10;      &lt;div className={`flex items-center justify-center bg-gradient-to-br from-[#d97757] to-[#c96846] text-white ${className}`}&gt;&#10;        {fallbackIcon || &lt;BookOpen className=&quot;h-4 w-4&quot; /&gt;}&#10;      &lt;/div&gt;&#10;    );&#10;  }&#10;&#10;  return (&#10;    &lt;&gt;&#10;      {/* eslint-disable-next-line @next/next/no-img-element */}&#10;      &lt;img&#10;        src={src}&#10;        alt={alt}&#10;        className={`object-cover ${className}`}&#10;        onError={(e) =&gt; {&#10;          const target = e.target as HTMLImageElement;&#10;          target.style.display = 'none';&#10;          if (target.nextElementSibling) {&#10;            (target.nextElementSibling as HTMLElement).style.display = 'flex';&#10;          }&#10;        }}&#10;      /&gt;&#10;      &lt;div&#10;        className={`items-center justify-center bg-gradient-to-br from-[#d97757] to-[#c96846] text-white ${className}`}&#10;        style={{ display: 'none' }}&#10;      &gt;&#10;        {fallbackIcon || &lt;BookOpen className=&quot;h-4 w-4&quot; /&gt;}&#10;      &lt;/div&gt;&#10;    &lt;/&gt;&#10;  );&#10;}&#10;" />
            </PendingDiffInfo>
          </value>
        </entry>
        <entry key="$PROJECT_DIR$/components/BannerImage.tsx">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/components/BannerImage.tsx" />
              <option name="updatedContent" value="&quot;use client&quot;;&#10;&#10;type BannerImageProps = {&#10;  src: string | null;&#10;  alt: string;&#10;  className?: string;&#10;  onLoad?: () =&gt; void;&#10;};&#10;&#10;export default function BannerImage({ src, alt, className = &quot;&quot;, onLoad }: BannerImageProps) {&#10;  if (!src) return null;&#10;&#10;  return (&#10;    &lt;div className=&quot;relative&quot;&gt;&#10;      {/* eslint-disable-next-line @next/next/no-img-element */}&#10;      &lt;img&#10;        src={src}&#10;        alt={alt}&#10;        className={className}&#10;        onError={(e) =&gt; {&#10;          const target = e.target as HTMLImageElement;&#10;          const parent = target.parentElement;&#10;          if (parent?.parentElement) {&#10;            parent.parentElement.style.display = 'none';&#10;          }&#10;        }}&#10;        onLoad={onLoad}&#10;      /&gt;&#10;    &lt;/div&gt;&#10;  );&#10;}&#10;" />
            </PendingDiffInfo>
          </value>
        </entry>
        <entry key="$PROJECT_DIR$/components/Header.tsx">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/components/Header.tsx" />
              <option name="originalContent" value="import Link from &quot;next/link&quot;;&#10;import { getSession, clearSession } from &quot;@/lib/session&quot;;&#10;import { query } from &quot;@/lib/db&quot;;&#10;import { ensureUserProfileColumns } from &quot;@/lib/migrations&quot;;&#10;import { redirect } from &quot;next/navigation&quot;;&#10;import GlowButton from &quot;@/components/ui/GlowButton&quot;;&#10;import { LogOut, Menu, Home, Send, Shield, BookOpen, FileText, Lock, Users, BarChart3, Sparkles, HelpCircle, ShieldAlert, AlertCircle, Heart, Info, DollarSign, User } from &quot;lucide-react&quot;;&#10;import { withBasePath } from &quot;@/lib/url&quot;;&#10;&#10;async function logout() {&#10;  &quot;use server&quot;;&#10;  await clearSession();&#10;  redirect(&quot;/&quot;);&#10;}&#10;&#10;import AuthHeartbeat from &quot;@/components/AuthHeartbeat&quot;;&#10;&#10;export default async function Header() {&#10;  const session = await getSession();&#10;  if (!session) return null;&#10;&#10;  await ensureUserProfileColumns();&#10;&#10;  // Get the actual username and avatar&#10;  const users = await query&lt;{ username: string; avatar_url: string | null }[]&gt;(&#10;    &quot;SELECT username, avatar_url FROM users WHERE id = ? LIMIT 1&quot;,&#10;    [session.userId]&#10;  );&#10;  const username = users[0]?.username || &quot;User&quot;;&#10;  const avatarUrl = users[0]?.avatar_url || null;&#10;  const role = session.role;&#10;  const isAdmin = role === &quot;admin&quot;;&#10;  const isModerator = role === &quot;moderator&quot; || isAdmin;&#10;&#10;  return (&#10;    &lt;header className=&quot;fixed top-6 left-6 right-6 md:left-auto md:right-6 z-50&quot;&gt;&#10;      &lt;AuthHeartbeat /&gt;&#10;      {/* Desktop header */}&#10;      &lt;div className=&quot;hidden md:flex justify-end&quot;&gt;&#10;        &lt;div className=&quot;flex items-center gap-4 backdrop-blur-xl bg-[#2a2520]/95 rounded-2xl pl-6 pr-3 py-3 shadow-lg border border-[#e89a7a]/10&quot;&gt;&#10;          &lt;span className=&quot;inline-flex items-center gap-3 text-sm text-[#b8aea5]&quot;&gt;&#10;            &lt;div className=&quot;flex items-center justify-center w-9 h-9 rounded-xl overflow-hidden bg-gradient-to-br from-[#d97757] to-[#c96846] text-white shadow-md&quot;&gt;&#10;              {avatarUrl ? (&#10;                // eslint-disable-next-line @next/next/no-img-element&#10;                &lt;img&#10;                  src={withBasePath(avatarUrl) || undefined}&#10;                  alt=&quot;Avatar&quot;&#10;                  className=&quot;w-full h-full object-cover&quot;&#10;                  onError={(e) =&gt; {&#10;                    const target = e.target as HTMLImageElement;&#10;                    target.style.display = 'none';&#10;                    if (target.nextElementSibling) {&#10;                      (target.nextElementSibling as HTMLElement).style.display = 'flex';&#10;                    }&#10;                  }}&#10;                /&gt;&#10;              ) : null}&#10;              &lt;div&#10;                className=&quot;w-full h-full flex items-center justify-center&quot;&#10;                style={{ display: avatarUrl ? 'none' : 'flex' }}&#10;              &gt;&#10;                &lt;BookOpen className=&quot;h-4 w-4&quot; /&gt;&#10;              &lt;/div&gt;&#10;            &lt;/div&gt;&#10;            &lt;span&gt;&#10;              Willkommen,{&quot; &quot;}&#10;              &lt;span className=&quot;font-semibold text-[#f5f1ed]&quot;&gt;{username}&lt;/span&gt;&#10;            &lt;/span&gt;&#10;          &lt;/span&gt;&#10;&#10;          {/* Desktop Navigation Dropdown */}&#10;          &lt;div className=&quot;relative group&quot;&gt;&#10;            &lt;button className=&quot;flex items-center gap-2 px-4 py-2 rounded-xl text-sm text-[#b8aea5] hover:text-[#f5f1ed] hover:bg-[#38302b] transition-all&quot;&gt;&#10;              &lt;Menu className=&quot;h-4 w-4&quot; /&gt;&#10;              &lt;span&gt;Navigation&lt;/span&gt;&#10;            &lt;/button&gt;&#10;&#10;            {/* Dropdown Menu */}&#10;            &lt;div className=&quot;absolute right-0 top-full pt-2 opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200&quot;&gt;&#10;              &lt;div className=&quot;min-w-64 backdrop-blur-xl bg-[#2a2520]/98 rounded-2xl shadow-2xl border border-[#e89a7a]/15 overflow-hidden&quot;&gt;&#10;                &lt;div className=&quot;py-2&quot;&gt;&#10;                  {/* Allgemein Section */}&#10;                  &lt;div className=&quot;px-3 py-2&quot;&gt;&#10;                    &lt;p className=&quot;text-xs font-semibold text-[#e89a7a] uppercase tracking-wider&quot;&gt;Allgemein&lt;/p&gt;&#10;                  &lt;/div&gt;&#10;                  &lt;Link&#10;                    href=&quot;/&quot;&#10;                    className=&quot;flex items-center gap-3 px-4 py-2.5 text-sm text-[#b8aea5] hover:bg-[#38302b] hover:text-[#e89a7a] transition-colors&quot;&#10;                  &gt;&#10;                    &lt;Home className=&quot;h-4 w-4&quot; /&gt;&#10;                    Startseite&#10;                  &lt;/Link&gt;&#10;                  &lt;Link&#10;                    href=&quot;/faq&quot;&#10;                    className=&quot;flex items-center gap-3 px-4 py-2.5 text-sm text-[#b8aea5] hover:bg-[#38302b] hover:text-[#e89a7a] transition-colors&quot;&#10;                  &gt;&#10;                    &lt;HelpCircle className=&quot;h-4 w-4&quot; /&gt;&#10;                    FAQ&#10;                  &lt;/Link&gt;&#10;                  &lt;Link&#10;                    href=&quot;/account&quot;&#10;                    className=&quot;flex items-center gap-3 px-4 py-2.5 text-sm text-[#b8aea5] hover:bg-[#38302b] hover:text-[#e89a7a] transition-colors&quot;&#10;                  &gt;&#10;                    &lt;User className=&quot;h-4 w-4&quot; /&gt;&#10;                    Mein Account&#10;                  &lt;/Link&gt;&#10;                  &lt;Link&#10;                    href=&quot;/datenschutz&quot;&#10;                    className=&quot;flex items-center gap-3 px-4 py-2.5 text-sm text-[#b8aea5] hover:bg-[#38302b] hover:text-[#e89a7a] transition-colors&quot;&#10;                  &gt;&#10;                    &lt;ShieldAlert className=&quot;h-4 w-4&quot; /&gt;&#10;                    Datenschutz&#10;                  &lt;/Link&gt;&#10;                  &lt;Link&#10;                    href=&quot;/browse&quot;&#10;                    className=&quot;flex items-center gap-3 px-4 py-2.5 text-sm text-[#b8aea5] hover:bg-[#38302b] hover:text-[#e89a7a] transition-colors&quot;&#10;                  &gt;&#10;                    &lt;FileText className=&quot;h-4 w-4&quot; /&gt;&#10;                    Beiträge durchsuchen&#10;                  &lt;/Link&gt;&#10;                  &lt;Link&#10;                    href=&quot;/sponsoren&quot;&#10;                    className=&quot;flex items-center gap-3 px-4 py-2.5 text-sm text-[#b8aea5] hover:bg-[#38302b] hover:text-[#e89a7a] transition-colors&quot;&#10;                  &gt;&#10;                    &lt;Heart className=&quot;h-4 w-4&quot; /&gt;&#10;                    Sponsoren&#10;                  &lt;/Link&gt;&#10;                  &lt;Link&#10;                    href=&quot;/sponsoring&quot;&#10;                    className=&quot;flex items-center gap-3 px-4 py-2.5 text-sm text-[#b8aea5] hover:bg-[#38302b] hover:text-[#e89a7a] transition-colors&quot;&#10;                  &gt;&#10;                    &lt;DollarSign className=&quot;h-4 w-4&quot; /&gt;&#10;                    Sponsoring&#10;                  &lt;/Link&gt;&#10;                  &lt;Link&#10;                    href=&quot;/sponsoring/info&quot;&#10;                    className=&quot;flex items-center gap-3 px-4 py-2.5 text-sm text-[#b8aea5] hover:bg-[#38302b] hover:text-[#e89a7a] transition-colors&quot;&#10;                  &gt;&#10;                    &lt;Info className=&quot;h-4 w-4&quot; /&gt;&#10;                    Sponsoring Info&#10;                  &lt;/Link&gt;&#10;&#10;                  {/* Phasen Section */}&#10;                  &lt;div className=&quot;border-t border-[#e89a7a]/10 mt-2 pt-2&quot;&gt;&#10;                    &lt;div className=&quot;px-3 py-2&quot;&gt;&#10;                      &lt;p className=&quot;text-xs font-semibold text-[#e89a7a] uppercase tracking-wider&quot;&gt;Phasen&lt;/p&gt;&#10;                    &lt;/div&gt;&#10;                    &lt;Link&#10;                      href=&quot;/phase-1&quot;&#10;                      className=&quot;flex items-center gap-3 px-4 py-2.5 text-sm text-[#b8aea5] hover:bg-[#38302b] hover:text-[#e89a7a] transition-colors&quot;&#10;                    &gt;&#10;                      &lt;Send className=&quot;h-4 w-4&quot; /&gt;&#10;                      Phase 1: Einsendungen&#10;                    &lt;/Link&gt;&#10;                    &lt;Link&#10;                      href=&quot;/phase-2&quot;&#10;                      className=&quot;flex items-center gap-3 px-4 py-2.5 text-sm text-[#b8aea5] hover:bg-[#38302b] hover:text-[#e89a7a] transition-colors&quot;&#10;                    &gt;&#10;                      &lt;BarChart3 className=&quot;h-4 w-4&quot; /&gt;&#10;                      Phase 2: Abstimmungen&#10;                    &lt;/Link&gt;&#10;                    &lt;Link&#10;                      href=&quot;/phase-3&quot;&#10;                      className=&quot;flex items-center gap-3 px-4 py-2.5 text-sm text-[#b8aea5] hover:bg-[#38302b] hover:text-[#e89a7a] transition-colors&quot;&#10;                    &gt;&#10;                      &lt;Sparkles className=&quot;h-4 w-4&quot; /&gt;&#10;                      Phase 3: Finalisierung&#10;                    &lt;/Link&gt;&#10;                  &lt;/div&gt;&#10;&#10;                  {/* Admin Section (für Moderatoren &amp; Admins) */}&#10;                  {isModerator &amp;&amp; (&#10;                    &lt;div className=&quot;border-t border-[#e89a7a]/10 mt-2 pt-2&quot;&gt;&#10;                      &lt;div className=&quot;px-3 py-2&quot;&gt;&#10;                        &lt;p className=&quot;text-xs font-semibold text-[#e89a7a] uppercase tracking-wider&quot;&gt;Administration&lt;/p&gt;&#10;                      &lt;/div&gt;&#10;                      &lt;Link&#10;                        href=&quot;/admin&quot;&#10;                        className=&quot;flex items-center gap-3 px-4 py-2.5 text-sm text-[#b8aea5] hover:bg-[#38302b] hover:text-[#e89a7a] transition-colors&quot;&#10;                      &gt;&#10;                        &lt;Shield className=&quot;h-4 w-4&quot; /&gt;&#10;                        Admin-Dashboard&#10;                      &lt;/Link&gt;&#10;                      {isAdmin &amp;&amp; (&#10;                        &lt;&gt;&#10;                          &lt;Link&#10;                            href=&quot;/admin/user&quot;&#10;                            className=&quot;flex items-center gap-3 px-4 py-2.5 text-sm text-[#b8aea5] hover:bg-[#38302b] hover:text-[#e89a7a] transition-colors&quot;&#10;                          &gt;&#10;                            &lt;Users className=&quot;h-4 w-4&quot; /&gt;&#10;                            Benutzerverwaltung&#10;                          &lt;/Link&gt;&#10;                          &lt;Link&#10;                            href=&quot;/zugriff-verweigert&quot;&#10;                            className=&quot;flex items-center gap-3 px-4 py-2.5 text-sm text-[#b8aea5] hover:bg-[#38302b] hover:text-[#e89a7a] transition-colors&quot;&#10;                          &gt;&#10;                            &lt;Lock className=&quot;h-4 w-4&quot; /&gt;&#10;                            Zugriff verweigert&#10;                          &lt;/Link&gt;&#10;                          &lt;Link&#10;                            href=&quot;/404&quot;&#10;                            className=&quot;flex items-center gap-3 px-4 py-2.5 text-sm text-[#b8aea5] hover:bg-[#38302b] hover:text-[#e89a7a] transition-colors&quot;&#10;                          &gt;&#10;                            &lt;AlertCircle className=&quot;h-4 w-4&quot; /&gt;&#10;                            404 Seite&#10;                          &lt;/Link&gt;&#10;                        &lt;/&gt;&#10;                      )}&#10;                    &lt;/div&gt;&#10;                  )}&#10;                &lt;/div&gt;&#10;              &lt;/div&gt;&#10;            &lt;/div&gt;&#10;          &lt;/div&gt;&#10;&#10;          &lt;form action={logout}&gt;&#10;            &lt;GlowButton&#10;              variant=&quot;ghost&quot;&#10;              className=&quot;text-sm px-4 py-2 hover:bg-[#38302b] rounded-xl transition-all&quot;&#10;              iconLeft={&lt;LogOut className=&quot;h-4 w-4&quot; /&gt;}&#10;            &gt;&#10;              Abmelden&#10;            &lt;/GlowButton&gt;&#10;          &lt;/form&gt;&#10;        &lt;/div&gt;&#10;      &lt;/div&gt;&#10;&#10;      {/* Mobile header with hamburger menu */}&#10;      &lt;div className=&quot;md:hidden&quot;&gt;&#10;        &lt;div className=&quot;flex items-center justify-between backdrop-blur-xl bg-[#2a2520]/95 rounded-2xl px-5 py-3 shadow-lg border border-[#e89a7a]/10&quot;&gt;&#10;          &lt;span className=&quot;inline-flex items-center gap-2.5 text-sm&quot;&gt;&#10;            &lt;div className=&quot;flex items-center justify-center w-8 h-8 rounded-lg overflow-hidden bg-gradient-to-br from-[#d97757] to-[#c96846] text-white shadow-md&quot;&gt;&#10;              {avatarUrl ? (&#10;                // eslint-disable-next-line @next/next/no-img-element&#10;                &lt;img&#10;                  src={withBasePath(avatarUrl) || undefined}&#10;                  alt=&quot;Avatar&quot;&#10;                  className=&quot;w-full h-full object-cover&quot;&#10;                  onError={(e) =&gt; {&#10;                    const target = e.target as HTMLImageElement;&#10;                    target.style.display = 'none';&#10;                    if (target.nextElementSibling) {&#10;                      (target.nextElementSibling as HTMLElement).style.display = 'flex';&#10;                    }&#10;                  }}&#10;                /&gt;&#10;              ) : null}&#10;              &lt;div&#10;                className=&quot;w-full h-full flex items-center justify-center&quot;&#10;                style={{ display: avatarUrl ? 'none' : 'flex' }}&#10;              &gt;&#10;                &lt;BookOpen className=&quot;h-4 w-4&quot; /&gt;&#10;              &lt;/div&gt;&#10;            &lt;/div&gt;&#10;            &lt;span className=&quot;font-medium text-[#f5f1ed]&quot;&gt;{username}&lt;/span&gt;&#10;          &lt;/span&gt;&#10;&#10;          &lt;details className=&quot;relative&quot;&gt;&#10;            &lt;summary className=&quot;list-none cursor-pointer p-2 rounded-lg hover:bg-[#38302b] transition-colors&quot;&gt;&#10;              &lt;Menu className=&quot;h-5 w-5 text-[#b8aea5]&quot; /&gt;&#10;            &lt;/summary&gt;&#10;&#10;            &lt;div className=&quot;absolute right-0 top-12 min-w-64 max-h-[80vh] overflow-y-auto backdrop-blur-xl bg-[#2a2520]/98 rounded-2xl shadow-xl border border-[#e89a7a]/10&quot;&gt;&#10;              &lt;div className=&quot;py-2&quot;&gt;&#10;                {/* Allgemein Section */}&#10;                &lt;div className=&quot;px-3 py-2&quot;&gt;&#10;                  &lt;p className=&quot;text-xs font-semibold text-[#e89a7a] uppercase tracking-wider&quot;&gt;Allgemein&lt;/p&gt;&#10;                &lt;/div&gt;&#10;                &lt;Link&#10;                  href=&quot;/&quot;&#10;                  className=&quot;flex items-center gap-3 px-4 py-3 text-sm text-[#b8aea5] hover:bg-[#38302b] hover:text-[#e89a7a] transition-colors&quot;&#10;                &gt;&#10;                  &lt;Home className=&quot;h-4 w-4&quot; /&gt;&#10;                  Startseite&#10;                &lt;/Link&gt;&#10;                &lt;Link&#10;                  href=&quot;/faq&quot;&#10;                  className=&quot;flex items-center gap-3 px-4 py-3 text-sm text-[#b8aea5] hover:bg-[#38302b] hover:text-[#e89a7a] transition-colors&quot;&#10;                &gt;&#10;                  &lt;HelpCircle className=&quot;h-4 w-4&quot; /&gt;&#10;                  FAQ&#10;                &lt;/Link&gt;&#10;                &lt;Link&#10;                  href=&quot;/account&quot;&#10;                  className=&quot;flex items-center gap-3 px-4 py-3 text-sm text-[#b8aea5] hover:bg-[#38302b] hover:text-[#e89a7a] transition-colors&quot;&#10;                &gt;&#10;                  &lt;User className=&quot;h-4 w-4&quot; /&gt;&#10;                  Mein Account&#10;                &lt;/Link&gt;&#10;                &lt;Link&#10;                  href=&quot;/datenschutz&quot;&#10;                  className=&quot;flex items-center gap-3 px-4 py-3 text-sm text-[#b8aea5] hover:bg-[#38302b] hover:text-[#e89a7a] transition-colors&quot;&#10;                &gt;&#10;                  &lt;ShieldAlert className=&quot;h-4 w-4&quot; /&gt;&#10;                  Datenschutz&#10;                &lt;/Link&gt;&#10;                &lt;Link&#10;                  href=&quot;/browse&quot;&#10;                  className=&quot;flex items-center gap-3 px-4 py-3 text-sm text-[#b8aea5] hover:bg-[#38302b] hover:text-[#e89a7a] transition-colors&quot;&#10;                &gt;&#10;                  &lt;FileText className=&quot;h-4 w-4&quot; /&gt;&#10;                  Beiträge durchsuchen&#10;                &lt;/Link&gt;&#10;                &lt;Link&#10;                  href=&quot;/sponsoren&quot;&#10;                  className=&quot;flex items-center gap-3 px-4 py-3 text-sm text-[#b8aea5] hover:bg-[#38302b] hover:text-[#e89a7a] transition-colors&quot;&#10;                &gt;&#10;                  &lt;Heart className=&quot;h-4 w-4&quot; /&gt;&#10;                  Sponsoren&#10;                &lt;/Link&gt;&#10;                &lt;Link&#10;                  href=&quot;/sponsoring&quot;&#10;                  className=&quot;flex items-center gap-3 px-4 py-3 text-sm text-[#b8aea5] hover:bg-[#38302b] hover:text-[#e89a7a] transition-colors&quot;&#10;                &gt;&#10;                  &lt;DollarSign className=&quot;h-4 w-4&quot; /&gt;&#10;                  Sponsoring&#10;                &lt;/Link&gt;&#10;                &lt;Link&#10;                  href=&quot;/sponsoring/info&quot;&#10;                  className=&quot;flex items-center gap-3 px-4 py-3 text-sm text-[#b8aea5] hover:bg-[#38302b] hover:text-[#e89a7a] transition-colors&quot;&#10;                &gt;&#10;                  &lt;Info className=&quot;h-4 w-4&quot; /&gt;&#10;                  Sponsoring Info&#10;                &lt;/Link&gt;&#10;&#10;                {/* Phasen Section */}&#10;                &lt;div className=&quot;border-t border-[#e89a7a]/10 mt-2 pt-2&quot;&gt;&#10;                  &lt;div className=&quot;px-3 py-2&quot;&gt;&#10;                    &lt;p className=&quot;text-xs font-semibold text-[#e89a7a] uppercase tracking-wider&quot;&gt;Phasen&lt;/p&gt;&#10;                  &lt;/div&gt;&#10;                  &lt;Link&#10;                    href=&quot;/phase-1&quot;&#10;                    className=&quot;flex items-center gap-3 px-4 py-3 text-sm text-[#b8aea5] hover:bg-[#38302b] hover:text-[#e89a7a] transition-colors&quot;&#10;                  &gt;&#10;                    &lt;Send className=&quot;h-4 w-4&quot; /&gt;&#10;                    Phase 1: Einsendungen&#10;                  &lt;/Link&gt;&#10;                  &lt;Link&#10;                    href=&quot;/phase-2&quot;&#10;                    className=&quot;flex items-center gap-3 px-4 py-3 text-sm text-[#b8aea5] hover:bg-[#38302b] hover:text-[#e89a7a] transition-colors&quot;&#10;                  &gt;&#10;                    &lt;BarChart3 className=&quot;h-4 w-4&quot; /&gt;&#10;                    Phase 2: Abstimmungen&#10;                  &lt;/Link&gt;&#10;                  &lt;Link&#10;                    href=&quot;/phase-3&quot;&#10;                    className=&quot;flex items-center gap-3 px-4 py-3 text-sm text-[#b8aea5] hover:bg-[#38302b] hover:text-[#e89a7a] transition-colors&quot;&#10;                  &gt;&#10;                    &lt;Sparkles className=&quot;h-4 w-4&quot; /&gt;&#10;                    Phase 3: Finalisierung&#10;                  &lt;/Link&gt;&#10;                &lt;/div&gt;&#10;&#10;                {/* Admin Section (für Moderatoren &amp; Admins) */}&#10;                {isModerator &amp;&amp; (&#10;                  &lt;div className=&quot;border-t border-[#e89a7a]/10 mt-2 pt-2&quot;&gt;&#10;                    &lt;div className=&quot;px-3 py-2&quot;&gt;&#10;                      &lt;p className=&quot;text-xs font-semibold text-[#e89a7a] uppercase tracking-wider&quot;&gt;Administration&lt;/p&gt;&#10;                    &lt;/div&gt;&#10;                    &lt;Link&#10;                      href=&quot;/admin&quot;&#10;                      className=&quot;flex items-center gap-3 px-4 py-3 text-sm text-[#b8aea5] hover:bg-[#38302b] hover:text-[#e89a7a] transition-colors&quot;&#10;                    &gt;&#10;                      &lt;Shield className=&quot;h-4 w-4&quot; /&gt;&#10;                      Admin-Dashboard&#10;                    &lt;/Link&gt;&#10;                    {isAdmin &amp;&amp; (&#10;                      &lt;&gt;&#10;                        &lt;Link&#10;                          href=&quot;/admin/user&quot;&#10;                          className=&quot;flex items-center gap-3 px-4 py-3 text-sm text-[#b8aea5] hover:bg-[#38302b] hover:text-[#e89a7a] transition-colors&quot;&#10;                        &gt;&#10;                          &lt;Users className=&quot;h-4 w-4&quot; /&gt;&#10;                          Benutzerverwaltung&#10;                        &lt;/Link&gt;&#10;                        &lt;Link&#10;                          href=&quot;/zugriff-verweigert&quot;&#10;                          className=&quot;flex items-center gap-3 px-4 py-3 text-sm text-[#b8aea5] hover:bg-[#38302b] hover:text-[#e89a7a] transition-colors&quot;&#10;                        &gt;&#10;                          &lt;Lock className=&quot;h-4 w-4&quot; /&gt;&#10;                          Zugriff verweigert&#10;                        &lt;/Link&gt;&#10;                        &lt;Link&#10;                          href=&quot;/404&quot;&#10;                          className=&quot;flex items-center gap-3 px-4 py-3 text-sm text-[#b8aea5] hover:bg-[#38302b] hover:text-[#e89a7a] transition-colors&quot;&#10;                        &gt;&#10;                          &lt;AlertCircle className=&quot;h-4 w-4&quot; /&gt;&#10;                          404 Seite&#10;                        &lt;/Link&gt;&#10;                      &lt;/&gt;&#10;                    )}&#10;                  &lt;/div&gt;&#10;                )}&#10;&#10;                {/* Abmelden */}&#10;                &lt;div className=&quot;border-t border-[#e89a7a]/10 mt-2 pt-2&quot;&gt;&#10;                  &lt;form action={logout} className=&quot;w-full&quot;&gt;&#10;                    &lt;button&#10;                      type=&quot;submit&quot;&#10;                      className=&quot;flex items-center gap-3 px-4 py-3 text-sm text-[#b8aea5] hover:bg-[#38302b] hover:text-[#e89a7a] transition-colors w-full text-left&quot;&#10;                    &gt;&#10;                      &lt;LogOut className=&quot;h-4 w-4&quot; /&gt;&#10;                      Abmelden&#10;                    &lt;/button&gt;&#10;                  &lt;/form&gt;&#10;                &lt;/div&gt;&#10;              &lt;/div&gt;&#10;            &lt;/div&gt;&#10;          &lt;/details&gt;&#10;        &lt;/div&gt;&#10;      &lt;/div&gt;&#10;    &lt;/header&gt;&#10;  );&#10;}&#10;" />
              <option name="updatedContent" value="import Link from &quot;next/link&quot;;&#10;import { getSession, clearSession } from &quot;@/lib/session&quot;;&#10;import { query } from &quot;@/lib/db&quot;;&#10;import { ensureUserProfileColumns } from &quot;@/lib/migrations&quot;;&#10;import { redirect } from &quot;next/navigation&quot;;&#10;import GlowButton from &quot;@/components/ui/GlowButton&quot;;&#10;import { LogOut, Menu, Home, Send, Shield, BookOpen, FileText, Lock, Users, BarChart3, Sparkles, HelpCircle, ShieldAlert, AlertCircle, Heart, Info, DollarSign, User } from &quot;lucide-react&quot;;&#10;import { withBasePath } from &quot;@/lib/url&quot;;&#10;import AvatarImage from &quot;@/components/AvatarImage&quot;;&#10;&#10;async function logout() {&#10;  &quot;use server&quot;;&#10;  await clearSession();&#10;  redirect(&quot;/&quot;);&#10;}&#10;&#10;import AuthHeartbeat from &quot;@/components/AuthHeartbeat&quot;;&#10;&#10;export default async function Header() {&#10;  const session = await getSession();&#10;  if (!session) return null;&#10;&#10;  await ensureUserProfileColumns();&#10;&#10;  // Get the actual username and avatar&#10;  const users = await query&lt;{ username: string; avatar_url: string | null }[]&gt;(&#10;    &quot;SELECT username, avatar_url FROM users WHERE id = ? LIMIT 1&quot;,&#10;    [session.userId]&#10;  );&#10;  const username = users[0]?.username || &quot;User&quot;;&#10;  const avatarUrl = users[0]?.avatar_url || null;&#10;  const role = session.role;&#10;  const isAdmin = role === &quot;admin&quot;;&#10;  const isModerator = role === &quot;moderator&quot; || isAdmin;&#10;&#10;  return (&#10;    &lt;header className=&quot;fixed top-6 left-6 right-6 md:left-auto md:right-6 z-50&quot;&gt;&#10;      &lt;AuthHeartbeat /&gt;&#10;      {/* Desktop header */}&#10;      &lt;div className=&quot;hidden md:flex justify-end&quot;&gt;&#10;        &lt;div className=&quot;flex items-center gap-4 backdrop-blur-xl bg-[#2a2520]/95 rounded-2xl pl-6 pr-3 py-3 shadow-lg border border-[#e89a7a]/10&quot;&gt;&#10;          &lt;span className=&quot;inline-flex items-center gap-3 text-sm text-[#b8aea5]&quot;&gt;&#10;            &lt;div className=&quot;flex items-center justify-center w-9 h-9 rounded-xl overflow-hidden bg-gradient-to-br from-[#d97757] to-[#c96846] text-white shadow-md&quot;&gt;&#10;              &lt;AvatarImage &#10;                src={withBasePath(avatarUrl)} &#10;                alt=&quot;Avatar&quot; &#10;                className=&quot;w-full h-full&quot;&#10;                fallbackIcon={&lt;BookOpen className=&quot;h-4 w-4&quot; /&gt;}&#10;              /&gt;&#10;            &lt;/div&gt;&#10;            &lt;span&gt;&#10;              Willkommen,{&quot; &quot;}&#10;              &lt;span className=&quot;font-semibold text-[#f5f1ed]&quot;&gt;{username}&lt;/span&gt;&#10;            &lt;/span&gt;&#10;          &lt;/span&gt;&#10;&#10;          {/* Desktop Navigation Dropdown */}&#10;          &lt;div className=&quot;relative group&quot;&gt;&#10;            &lt;button className=&quot;flex items-center gap-2 px-4 py-2 rounded-xl text-sm text-[#b8aea5] hover:text-[#f5f1ed] hover:bg-[#38302b] transition-all&quot;&gt;&#10;              &lt;Menu className=&quot;h-4 w-4&quot; /&gt;&#10;              &lt;span&gt;Navigation&lt;/span&gt;&#10;            &lt;/button&gt;&#10;&#10;            {/* Dropdown Menu */}&#10;            &lt;div className=&quot;absolute right-0 top-full pt-2 opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200&quot;&gt;&#10;              &lt;div className=&quot;min-w-64 backdrop-blur-xl bg-[#2a2520]/98 rounded-2xl shadow-2xl border border-[#e89a7a]/15 overflow-hidden&quot;&gt;&#10;                &lt;div className=&quot;py-2&quot;&gt;&#10;                  {/* Allgemein Section */}&#10;                  &lt;div className=&quot;px-3 py-2&quot;&gt;&#10;                    &lt;p className=&quot;text-xs font-semibold text-[#e89a7a] uppercase tracking-wider&quot;&gt;Allgemein&lt;/p&gt;&#10;                  &lt;/div&gt;&#10;                  &lt;Link&#10;                    href=&quot;/&quot;&#10;                    className=&quot;flex items-center gap-3 px-4 py-2.5 text-sm text-[#b8aea5] hover:bg-[#38302b] hover:text-[#e89a7a] transition-colors&quot;&#10;                  &gt;&#10;                    &lt;Home className=&quot;h-4 w-4&quot; /&gt;&#10;                    Startseite&#10;                  &lt;/Link&gt;&#10;                  &lt;Link&#10;                    href=&quot;/faq&quot;&#10;                    className=&quot;flex items-center gap-3 px-4 py-2.5 text-sm text-[#b8aea5] hover:bg-[#38302b] hover:text-[#e89a7a] transition-colors&quot;&#10;                  &gt;&#10;                    &lt;HelpCircle className=&quot;h-4 w-4&quot; /&gt;&#10;                    FAQ&#10;                  &lt;/Link&gt;&#10;                  &lt;Link&#10;                    href=&quot;/account&quot;&#10;                    className=&quot;flex items-center gap-3 px-4 py-2.5 text-sm text-[#b8aea5] hover:bg-[#38302b] hover:text-[#e89a7a] transition-colors&quot;&#10;                  &gt;&#10;                    &lt;User className=&quot;h-4 w-4&quot; /&gt;&#10;                    Mein Account&#10;                  &lt;/Link&gt;&#10;                  &lt;Link&#10;                    href=&quot;/datenschutz&quot;&#10;                    className=&quot;flex items-center gap-3 px-4 py-2.5 text-sm text-[#b8aea5] hover:bg-[#38302b] hover:text-[#e89a7a] transition-colors&quot;&#10;                  &gt;&#10;                    &lt;ShieldAlert className=&quot;h-4 w-4&quot; /&gt;&#10;                    Datenschutz&#10;                  &lt;/Link&gt;&#10;                  &lt;Link&#10;                    href=&quot;/browse&quot;&#10;                    className=&quot;flex items-center gap-3 px-4 py-2.5 text-sm text-[#b8aea5] hover:bg-[#38302b] hover:text-[#e89a7a] transition-colors&quot;&#10;                  &gt;&#10;                    &lt;FileText className=&quot;h-4 w-4&quot; /&gt;&#10;                    Beiträge durchsuchen&#10;                  &lt;/Link&gt;&#10;                  &lt;Link&#10;                    href=&quot;/sponsoren&quot;&#10;                    className=&quot;flex items-center gap-3 px-4 py-2.5 text-sm text-[#b8aea5] hover:bg-[#38302b] hover:text-[#e89a7a] transition-colors&quot;&#10;                  &gt;&#10;                    &lt;Heart className=&quot;h-4 w-4&quot; /&gt;&#10;                    Sponsoren&#10;                  &lt;/Link&gt;&#10;                  &lt;Link&#10;                    href=&quot;/sponsoring&quot;&#10;                    className=&quot;flex items-center gap-3 px-4 py-2.5 text-sm text-[#b8aea5] hover:bg-[#38302b] hover:text-[#e89a7a] transition-colors&quot;&#10;                  &gt;&#10;                    &lt;DollarSign className=&quot;h-4 w-4&quot; /&gt;&#10;                    Sponsoring&#10;                  &lt;/Link&gt;&#10;                  &lt;Link&#10;                    href=&quot;/sponsoring/info&quot;&#10;                    className=&quot;flex items-center gap-3 px-4 py-2.5 text-sm text-[#b8aea5] hover:bg-[#38302b] hover:text-[#e89a7a] transition-colors&quot;&#10;                  &gt;&#10;                    &lt;Info className=&quot;h-4 w-4&quot; /&gt;&#10;                    Sponsoring Info&#10;                  &lt;/Link&gt;&#10;&#10;                  {/* Phasen Section */}&#10;                  &lt;div className=&quot;border-t border-[#e89a7a]/10 mt-2 pt-2&quot;&gt;&#10;                    &lt;div className=&quot;px-3 py-2&quot;&gt;&#10;                      &lt;p className=&quot;text-xs font-semibold text-[#e89a7a] uppercase tracking-wider&quot;&gt;Phasen&lt;/p&gt;&#10;                    &lt;/div&gt;&#10;                    &lt;Link&#10;                      href=&quot;/phase-1&quot;&#10;                      className=&quot;flex items-center gap-3 px-4 py-2.5 text-sm text-[#b8aea5] hover:bg-[#38302b] hover:text-[#e89a7a] transition-colors&quot;&#10;                    &gt;&#10;                      &lt;Send className=&quot;h-4 w-4&quot; /&gt;&#10;                      Phase 1: Einsendungen&#10;                    &lt;/Link&gt;&#10;                    &lt;Link&#10;                      href=&quot;/phase-2&quot;&#10;                      className=&quot;flex items-center gap-3 px-4 py-2.5 text-sm text-[#b8aea5] hover:bg-[#38302b] hover:text-[#e89a7a] transition-colors&quot;&#10;                    &gt;&#10;                      &lt;BarChart3 className=&quot;h-4 w-4&quot; /&gt;&#10;                      Phase 2: Abstimmungen&#10;                    &lt;/Link&gt;&#10;                    &lt;Link&#10;                      href=&quot;/phase-3&quot;&#10;                      className=&quot;flex items-center gap-3 px-4 py-2.5 text-sm text-[#b8aea5] hover:bg-[#38302b] hover:text-[#e89a7a] transition-colors&quot;&#10;                    &gt;&#10;                      &lt;Sparkles className=&quot;h-4 w-4&quot; /&gt;&#10;                      Phase 3: Finalisierung&#10;                    &lt;/Link&gt;&#10;                  &lt;/div&gt;&#10;&#10;                  {/* Admin Section (für Moderatoren &amp; Admins) */}&#10;                  {isModerator &amp;&amp; (&#10;                    &lt;div className=&quot;border-t border-[#e89a7a]/10 mt-2 pt-2&quot;&gt;&#10;                      &lt;div className=&quot;px-3 py-2&quot;&gt;&#10;                        &lt;p className=&quot;text-xs font-semibold text-[#e89a7a] uppercase tracking-wider&quot;&gt;Administration&lt;/p&gt;&#10;                      &lt;/div&gt;&#10;                      &lt;Link&#10;                        href=&quot;/admin&quot;&#10;                        className=&quot;flex items-center gap-3 px-4 py-2.5 text-sm text-[#b8aea5] hover:bg-[#38302b] hover:text-[#e89a7a] transition-colors&quot;&#10;                      &gt;&#10;                        &lt;Shield className=&quot;h-4 w-4&quot; /&gt;&#10;                        Admin-Dashboard&#10;                      &lt;/Link&gt;&#10;                      {isAdmin &amp;&amp; (&#10;                        &lt;&gt;&#10;                          &lt;Link&#10;                            href=&quot;/admin/user&quot;&#10;                            className=&quot;flex items-center gap-3 px-4 py-2.5 text-sm text-[#b8aea5] hover:bg-[#38302b] hover:text-[#e89a7a] transition-colors&quot;&#10;                          &gt;&#10;                            &lt;Users className=&quot;h-4 w-4&quot; /&gt;&#10;                            Benutzerverwaltung&#10;                          &lt;/Link&gt;&#10;                          &lt;Link&#10;                            href=&quot;/zugriff-verweigert&quot;&#10;                            className=&quot;flex items-center gap-3 px-4 py-2.5 text-sm text-[#b8aea5] hover:bg-[#38302b] hover:text-[#e89a7a] transition-colors&quot;&#10;                          &gt;&#10;                            &lt;Lock className=&quot;h-4 w-4&quot; /&gt;&#10;                            Zugriff verweigert&#10;                          &lt;/Link&gt;&#10;                          &lt;Link&#10;                            href=&quot;/404&quot;&#10;                            className=&quot;flex items-center gap-3 px-4 py-2.5 text-sm text-[#b8aea5] hover:bg-[#38302b] hover:text-[#e89a7a] transition-colors&quot;&#10;                          &gt;&#10;                            &lt;AlertCircle className=&quot;h-4 w-4&quot; /&gt;&#10;                            404 Seite&#10;                          &lt;/Link&gt;&#10;                        &lt;/&gt;&#10;                      )}&#10;                    &lt;/div&gt;&#10;                  )}&#10;                &lt;/div&gt;&#10;              &lt;/div&gt;&#10;            &lt;/div&gt;&#10;          &lt;/div&gt;&#10;&#10;          &lt;form action={logout}&gt;&#10;            &lt;GlowButton&#10;              variant=&quot;ghost&quot;&#10;              className=&quot;text-sm px-4 py-2 hover:bg-[#38302b] rounded-xl transition-all&quot;&#10;              iconLeft={&lt;LogOut className=&quot;h-4 w-4&quot; /&gt;}&#10;            &gt;&#10;              Abmelden&#10;            &lt;/GlowButton&gt;&#10;          &lt;/form&gt;&#10;        &lt;/div&gt;&#10;      &lt;/div&gt;&#10;&#10;      {/* Mobile header with hamburger menu */}&#10;      &lt;div className=&quot;md:hidden&quot;&gt;&#10;        &lt;div className=&quot;flex items-center justify-between backdrop-blur-xl bg-[#2a2520]/95 rounded-2xl px-5 py-3 shadow-lg border border-[#e89a7a]/10&quot;&gt;&#10;          &lt;span className=&quot;inline-flex items-center gap-2.5 text-sm&quot;&gt;&#10;            &lt;div className=&quot;flex items-center justify-center w-8 h-8 rounded-lg overflow-hidden bg-gradient-to-br from-[#d97757] to-[#c96846] text-white shadow-md&quot;&gt;&#10;              &lt;AvatarImage &#10;                src={withBasePath(avatarUrl)} &#10;                alt=&quot;Avatar&quot; &#10;                className=&quot;w-full h-full&quot;&#10;                fallbackIcon={&lt;BookOpen className=&quot;h-4 w-4&quot; /&gt;}&#10;              /&gt;&#10;            &lt;/div&gt;&#10;            &lt;span className=&quot;font-medium text-[#f5f1ed]&quot;&gt;{username}&lt;/span&gt;&#10;          &lt;/span&gt;&#10;&#10;          &lt;details className=&quot;relative&quot;&gt;&#10;            &lt;summary className=&quot;list-none cursor-pointer p-2 rounded-lg hover:bg-[#38302b] transition-colors&quot;&gt;&#10;              &lt;Menu className=&quot;h-5 w-5 text-[#b8aea5]&quot; /&gt;&#10;            &lt;/summary&gt;&#10;&#10;            &lt;div className=&quot;absolute right-0 top-12 min-w-64 max-h-[80vh] overflow-y-auto backdrop-blur-xl bg-[#2a2520]/98 rounded-2xl shadow-xl border border-[#e89a7a]/10&quot;&gt;&#10;              &lt;div className=&quot;py-2&quot;&gt;&#10;                {/* Allgemein Section */}&#10;                &lt;div className=&quot;px-3 py-2&quot;&gt;&#10;                  &lt;p className=&quot;text-xs font-semibold text-[#e89a7a] uppercase tracking-wider&quot;&gt;Allgemein&lt;/p&gt;&#10;                &lt;/div&gt;&#10;                &lt;Link&#10;                  href=&quot;/&quot;&#10;                  className=&quot;flex items-center gap-3 px-4 py-3 text-sm text-[#b8aea5] hover:bg-[#38302b] hover:text-[#e89a7a] transition-colors&quot;&#10;                &gt;&#10;                  &lt;Home className=&quot;h-4 w-4&quot; /&gt;&#10;                  Startseite&#10;                &lt;/Link&gt;&#10;                &lt;Link&#10;                  href=&quot;/faq&quot;&#10;                  className=&quot;flex items-center gap-3 px-4 py-3 text-sm text-[#b8aea5] hover:bg-[#38302b] hover:text-[#e89a7a] transition-colors&quot;&#10;                &gt;&#10;                  &lt;HelpCircle className=&quot;h-4 w-4&quot; /&gt;&#10;                  FAQ&#10;                &lt;/Link&gt;&#10;                &lt;Link&#10;                  href=&quot;/account&quot;&#10;                  className=&quot;flex items-center gap-3 px-4 py-3 text-sm text-[#b8aea5] hover:bg-[#38302b] hover:text-[#e89a7a] transition-colors&quot;&#10;                &gt;&#10;                  &lt;User className=&quot;h-4 w-4&quot; /&gt;&#10;                  Mein Account&#10;                &lt;/Link&gt;&#10;                &lt;Link&#10;                  href=&quot;/datenschutz&quot;&#10;                  className=&quot;flex items-center gap-3 px-4 py-3 text-sm text-[#b8aea5] hover:bg-[#38302b] hover:text-[#e89a7a] transition-colors&quot;&#10;                &gt;&#10;                  &lt;ShieldAlert className=&quot;h-4 w-4&quot; /&gt;&#10;                  Datenschutz&#10;                &lt;/Link&gt;&#10;                &lt;Link&#10;                  href=&quot;/browse&quot;&#10;                  className=&quot;flex items-center gap-3 px-4 py-3 text-sm text-[#b8aea5] hover:bg-[#38302b] hover:text-[#e89a7a] transition-colors&quot;&#10;                &gt;&#10;                  &lt;FileText className=&quot;h-4 w-4&quot; /&gt;&#10;                  Beiträge durchsuchen&#10;                &lt;/Link&gt;&#10;                &lt;Link&#10;                  href=&quot;/sponsoren&quot;&#10;                  className=&quot;flex items-center gap-3 px-4 py-3 text-sm text-[#b8aea5] hover:bg-[#38302b] hover:text-[#e89a7a] transition-colors&quot;&#10;                &gt;&#10;                  &lt;Heart className=&quot;h-4 w-4&quot; /&gt;&#10;                  Sponsoren&#10;                &lt;/Link&gt;&#10;                &lt;Link&#10;                  href=&quot;/sponsoring&quot;&#10;                  className=&quot;flex items-center gap-3 px-4 py-3 text-sm text-[#b8aea5] hover:bg-[#38302b] hover:text-[#e89a7a] transition-colors&quot;&#10;                &gt;&#10;                  &lt;DollarSign className=&quot;h-4 w-4&quot; /&gt;&#10;                  Sponsoring&#10;                &lt;/Link&gt;&#10;                &lt;Link&#10;                  href=&quot;/sponsoring/info&quot;&#10;                  className=&quot;flex items-center gap-3 px-4 py-3 text-sm text-[#b8aea5] hover:bg-[#38302b] hover:text-[#e89a7a] transition-colors&quot;&#10;                &gt;&#10;                  &lt;Info className=&quot;h-4 w-4&quot; /&gt;&#10;                  Sponsoring Info&#10;                &lt;/Link&gt;&#10;&#10;                {/* Phasen Section */}&#10;                &lt;div className=&quot;border-t border-[#e89a7a]/10 mt-2 pt-2&quot;&gt;&#10;                  &lt;div className=&quot;px-3 py-2&quot;&gt;&#10;                    &lt;p className=&quot;text-xs font-semibold text-[#e89a7a] uppercase tracking-wider&quot;&gt;Phasen&lt;/p&gt;&#10;                  &lt;/div&gt;&#10;                  &lt;Link&#10;                    href=&quot;/phase-1&quot;&#10;                    className=&quot;flex items-center gap-3 px-4 py-3 text-sm text-[#b8aea5] hover:bg-[#38302b] hover:text-[#e89a7a] transition-colors&quot;&#10;                  &gt;&#10;                    &lt;Send className=&quot;h-4 w-4&quot; /&gt;&#10;                    Phase 1: Einsendungen&#10;                  &lt;/Link&gt;&#10;                  &lt;Link&#10;                    href=&quot;/phase-2&quot;&#10;                    className=&quot;flex items-center gap-3 px-4 py-3 text-sm text-[#b8aea5] hover:bg-[#38302b] hover:text-[#e89a7a] transition-colors&quot;&#10;                  &gt;&#10;                    &lt;BarChart3 className=&quot;h-4 w-4&quot; /&gt;&#10;                    Phase 2: Abstimmungen&#10;                  &lt;/Link&gt;&#10;                  &lt;Link&#10;                    href=&quot;/phase-3&quot;&#10;                    className=&quot;flex items-center gap-3 px-4 py-3 text-sm text-[#b8aea5] hover:bg-[#38302b] hover:text-[#e89a7a] transition-colors&quot;&#10;                  &gt;&#10;                    &lt;Sparkles className=&quot;h-4 w-4&quot; /&gt;&#10;                    Phase 3: Finalisierung&#10;                  &lt;/Link&gt;&#10;                &lt;/div&gt;&#10;&#10;                {/* Admin Section (für Moderatoren &amp; Admins) */}&#10;                {isModerator &amp;&amp; (&#10;                  &lt;div className=&quot;border-t border-[#e89a7a]/10 mt-2 pt-2&quot;&gt;&#10;                    &lt;div className=&quot;px-3 py-2&quot;&gt;&#10;                      &lt;p className=&quot;text-xs font-semibold text-[#e89a7a] uppercase tracking-wider&quot;&gt;Administration&lt;/p&gt;&#10;                    &lt;/div&gt;&#10;                    &lt;Link&#10;                      href=&quot;/admin&quot;&#10;                      className=&quot;flex items-center gap-3 px-4 py-3 text-sm text-[#b8aea5] hover:bg-[#38302b] hover:text-[#e89a7a] transition-colors&quot;&#10;                    &gt;&#10;                      &lt;Shield className=&quot;h-4 w-4&quot; /&gt;&#10;                      Admin-Dashboard&#10;                    &lt;/Link&gt;&#10;                    {isAdmin &amp;&amp; (&#10;                      &lt;&gt;&#10;                        &lt;Link&#10;                          href=&quot;/admin/user&quot;&#10;                          className=&quot;flex items-center gap-3 px-4 py-3 text-sm text-[#b8aea5] hover:bg-[#38302b] hover:text-[#e89a7a] transition-colors&quot;&#10;                        &gt;&#10;                          &lt;Users className=&quot;h-4 w-4&quot; /&gt;&#10;                          Benutzerverwaltung&#10;                        &lt;/Link&gt;&#10;                        &lt;Link&#10;                          href=&quot;/zugriff-verweigert&quot;&#10;                          className=&quot;flex items-center gap-3 px-4 py-3 text-sm text-[#b8aea5] hover:bg-[#38302b] hover:text-[#e89a7a] transition-colors&quot;&#10;                        &gt;&#10;                          &lt;Lock className=&quot;h-4 w-4&quot; /&gt;&#10;                          Zugriff verweigert&#10;                        &lt;/Link&gt;&#10;                        &lt;Link&#10;                          href=&quot;/404&quot;&#10;                          className=&quot;flex items-center gap-3 px-4 py-3 text-sm text-[#b8aea5] hover:bg-[#38302b] hover:text-[#e89a7a] transition-colors&quot;&#10;                        &gt;&#10;                          &lt;AlertCircle className=&quot;h-4 w-4&quot; /&gt;&#10;                          404 Seite&#10;                        &lt;/Link&gt;&#10;                      &lt;/&gt;&#10;                    )}&#10;                  &lt;/div&gt;&#10;                )}&#10;&#10;                {/* Abmelden */}&#10;                &lt;div className=&quot;border-t border-[#e89a7a]/10 mt-2 pt-2&quot;&gt;&#10;                  &lt;form action={logout} className=&quot;w-full&quot;&gt;&#10;                    &lt;button&#10;                      type=&quot;submit&quot;&#10;                      className=&quot;flex items-center gap-3 px-4 py-3 text-sm text-[#b8aea5] hover:bg-[#38302b] hover:text-[#e89a7a] transition-colors w-full text-left&quot;&#10;                    &gt;&#10;                      &lt;LogOut className=&quot;h-4 w-4&quot; /&gt;&#10;                      Abmelden&#10;                    &lt;/button&gt;&#10;                  &lt;/form&gt;&#10;                &lt;/div&gt;&#10;              &lt;/div&gt;&#10;            &lt;/div&gt;&#10;          &lt;/details&gt;&#10;        &lt;/div&gt;&#10;      &lt;/div&gt;&#10;    &lt;/header&gt;&#10;  );&#10;}&#10;" />
            </PendingDiffInfo>
          </value>
        </entry>
        <entry key="$PROJECT_DIR$/components/ProfileAvatar.tsx">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/components/ProfileAvatar.tsx" />
              <option name="originalContent" value="&quot;use client&quot;;&#10;&#10;import { useEffect, useRef, useState } from &quot;react&quot;;&#10;import { createPortal } from &quot;react-dom&quot;;&#10;import { BookOpen, Shield } from &quot;lucide-react&quot;;&#10;import { withBasePath } from &quot;@/lib/url&quot;;&#10;&#10;export type PublicUser = {&#10;  id: number;&#10;  username: string;&#10;  class: string | null;&#10;  bio: string | null;&#10;  avatar_url: string | null;&#10;  banner_url: string | null;&#10;  role: 'user' | 'moderator' | 'admin';&#10;};&#10;&#10;type Props = {&#10;  userId: number;&#10;  username?: string;&#10;  avatarUrl?: string | null;&#10;  size?: number; // px&#10;  className?: string;&#10;};&#10;&#10;export default function ProfileAvatar({ userId, username, avatarUrl, size = 28, className = &quot;&quot; }: Props) {&#10;  const [open, setOpen] = useState(false);&#10;  const [loading, setLoading] = useState(false);&#10;  const [followBusy, setFollowBusy] = useState(false);&#10;  const [user, setUser] = useState&lt;PublicUser | null&gt;(&#10;    username || avatarUrl ? { id: userId, username: username || &quot;&quot;, class: null, bio: null, avatar_url: avatarUrl ?? null, banner_url: null, role: 'user' } : null&#10;  );&#10;  const [stats, setStats] = useState&lt;{ follower_count: number; following_count: number; is_following: boolean; is_me?: boolean } | null&gt;(null);&#10;  const btnRef = useRef&lt;HTMLDivElement&gt;(null);&#10;  const popRef = useRef&lt;HTMLDivElement&gt;(null);&#10;  const [pos, setPos] = useState&lt;{ top: number; left: number; placement: 'top' | 'bottom' } | null&gt;(null);&#10;&#10;  useEffect(() =&gt; {&#10;    function onDocClick(e: MouseEvent) {&#10;      if (!open) return;&#10;      const t = e.target as Node;&#10;      if (btnRef.current &amp;&amp; btnRef.current.contains(t)) return;&#10;      if (popRef.current &amp;&amp; popRef.current.contains(t)) return;&#10;      setOpen(false);&#10;    }&#10;    document.addEventListener(&quot;mousedown&quot;, onDocClick);&#10;    return () =&gt; document.removeEventListener(&quot;mousedown&quot;, onDocClick);&#10;  }, [open]);&#10;&#10;  // Eagerly load avatar/public info so the profile image is visible without clicking&#10;  useEffect(() =&gt; {&#10;    // If avatar is already known via props or state, skip fetching&#10;    if (user?.avatar_url || avatarUrl) return;&#10;    let active = true;&#10;    fetch(`/api/users/public?userId=${userId}`)&#10;      .then(async (r) =&gt; {&#10;        if (!r.ok) throw new Error(&quot;load failed&quot;);&#10;        const data = await r.json();&#10;        if (!active) return;&#10;        setUser(data.user as PublicUser);&#10;        setStats(data.stats as { follower_count: number; following_count: number; is_following: boolean; is_me?: boolean });&#10;      })&#10;      .catch(() =&gt; {});&#10;    return () =&gt; { active = false; };&#10;  }, [userId]);&#10;&#10;  useEffect(() =&gt; {&#10;    if (!open) return;&#10;    if (user &amp;&amp; user.bio !== null) return; // already fetched full&#10;    setLoading(true);&#10;    fetch(`/api/users/public?userId=${userId}`)&#10;      .then(async (r) =&gt; {&#10;        if (!r.ok) throw new Error(&quot;load failed&quot;);&#10;        const data = await r.json();&#10;        setUser(data.user as PublicUser);&#10;        setStats(data.stats as { follower_count: number; following_count: number; is_following: boolean; is_me?: boolean });&#10;      })&#10;      .catch(() =&gt; {})&#10;      .finally(() =&gt; setLoading(false));&#10;  }, [open, userId]);&#10;&#10;  // Compute and update popover viewport position when opened and on scroll/resize&#10;  useEffect(() =&gt; {&#10;    if (!open) return;&#10;    function compute() {&#10;      const btn = btnRef.current;&#10;      const pop = popRef.current;&#10;      if (!btn || !pop) return;&#10;      const rect = btn.getBoundingClientRect();&#10;      const spacing = 8;&#10;      const popRect = pop.getBoundingClientRect();&#10;      let top = rect.bottom + spacing;&#10;      let placement: 'top' | 'bottom' = 'bottom';&#10;      if (top + popRect.height &gt; window.innerHeight - 8) {&#10;        top = Math.max(8, rect.top - spacing - popRect.height);&#10;        placement = 'top';&#10;      }&#10;      let left = rect.left;&#10;      if (left + popRect.width &gt; window.innerWidth - 8) {&#10;        left = Math.max(8, window.innerWidth - 8 - popRect.width);&#10;      }&#10;      if (left &lt; 8) left = 8;&#10;      setPos({ top, left, placement });&#10;    }&#10;    compute();&#10;    const handler = () =&gt; compute();&#10;    window.addEventListener('scroll', handler, true);&#10;    window.addEventListener('resize', handler);&#10;    return () =&gt; {&#10;      window.removeEventListener('scroll', handler, true);&#10;      window.removeEventListener('resize', handler);&#10;    };&#10;  }, [open]);&#10;&#10;  const avatar = user?.avatar_url ?? avatarUrl ?? null;&#10;  const avatarSrc = withBasePath(avatar);&#10;  const bannerSrc = withBasePath(user?.banner_url ?? null);&#10;  const label = user?.username || username || &quot;User&quot;;&#10;&#10;  return (&#10;    &lt;div className={`relative inline-flex items-center ${className}`}&gt;&#10;      &lt;div&#10;        ref={btnRef}&#10;        role=&quot;button&quot;&#10;        tabIndex={0}&#10;        aria-haspopup=&quot;dialog&quot;&#10;        aria-expanded={open}&#10;        onClick={(e) =&gt; { e.stopPropagation(); setOpen((v) =&gt; !v); }}&#10;        onKeyDown={(e) =&gt; {&#10;          if (e.key === 'Enter' || e.key === ' ') {&#10;            e.preventDefault();&#10;            e.stopPropagation();&#10;            setOpen((v) =&gt; !v);&#10;          }&#10;        }}&#10;        className=&quot;rounded-full border border-[#e89a7a]/20 overflow-hidden focus:outline-none focus:ring-2 focus:ring-[#e89a7a]/40&quot;&#10;        style={{ width: size, height: size }}&#10;        title={label}&#10;      &gt;&#10;        {avatar ? (&#10;          // eslint-disable-next-line @next/next/no-img-element&#10;          &lt;img&#10;            src={avatarSrc || undefined}&#10;            alt={label}&#10;            className=&quot;w-full h-full object-cover&quot;&#10;            onError={(e) =&gt; {&#10;              // Fallback wenn Bild nicht geladen werden kann&#10;              const target = e.target as HTMLImageElement;&#10;              target.style.display = 'none';&#10;              if (target.nextElementSibling) {&#10;                (target.nextElementSibling as HTMLElement).style.display = 'flex';&#10;              }&#10;            }}&#10;          /&gt;&#10;        ) : null}&#10;        &lt;div&#10;          className=&quot;w-full h-full flex items-center justify-center bg-gradient-to-br from-[#d97757] to-[#c96846] text-white&quot;&#10;          style={{ display: avatar ? 'none' : 'flex' }}&#10;        &gt;&#10;          &lt;BookOpen className=&quot;w-3.5 h-3.5&quot; /&gt;&#10;        &lt;/div&gt;&#10;      &lt;/div&gt;&#10;&#10;      {open &amp;&amp; typeof window !== 'undefined' &amp;&amp; createPortal(&#10;        &lt;div&#10;          ref={popRef}&#10;          role=&quot;dialog&quot;&#10;          aria-label={`Profil von ${label}`}&#10;          className=&quot;fixed z-[1000] min-w-[260px] max-w-[360px] p-4 rounded-2xl border border-[#e89a7a]/20 bg-[#2a2520]/98 backdrop-blur-xl shadow-2xl&quot;&#10;          style={{ top: pos?.top ?? -9999, left: pos?.left ?? -9999 }}&#10;        &gt;&#10;          {user?.banner_url &amp;&amp; (&#10;            &lt;div className=&quot;-mt-1 -mx-1 mb-3 relative&quot;&gt;&#10;              {/* eslint-disable-next-line @next/next/no-img-element */}&#10;              &lt;img&#10;                src={bannerSrc || undefined}&#10;                alt=&quot;Profilbanner&quot;&#10;                className=&quot;w-full h-20 object-cover rounded-xl border border-[#e89a7a]/20&quot;&#10;                onError={(e) =&gt; {&#10;                  // Verstecke Banner wenn Bild nicht geladen werden kann&#10;                  const target = e.target as HTMLImageElement;&#10;                  const parent = target.parentElement;&#10;                  if (parent) {&#10;                    parent.style.display = 'none';&#10;                  }&#10;                }}&#10;                onLoad={() =&gt; {&#10;                  const btn = btnRef.current; const pop = popRef.current; if (!btn || !pop) return; const rect = btn.getBoundingClientRect(); const spacing = 8; const popRect = pop.getBoundingClientRect(); let top = rect.bottom + spacing; let placement: 'top' | 'bottom' = 'bottom'; if (top + popRect.height &gt; window.innerHeight - 8) { top = Math.max(8, rect.top - spacing - popRect.height); placement = 'top'; } let left = rect.left; if (left + popRect.width &gt; window.innerWidth - 8) { left = Math.max(8, window.innerWidth - 8 - popRect.width); } if (left &lt; 8) left = 8; setPos({ top, left, placement });&#10;                }}&#10;              /&gt;&#10;            &lt;/div&gt;&#10;          )}&#10;          &lt;div className=&quot;flex items-center gap-3 mb-3&quot;&gt;&#10;            &lt;div className=&quot;w-12 h-12 rounded-xl overflow-hidden border border-[#e89a7a]/20&quot;&gt;&#10;              {avatar ? (&#10;                // eslint-disable-next-line @next/next/no-img-element&#10;                &lt;img&#10;                  src={avatarSrc || undefined}&#10;                  alt={label}&#10;                  className=&quot;w-full h-full object-cover&quot;&#10;                  onError={(e) =&gt; {&#10;                    const target = e.target as HTMLImageElement;&#10;                    target.style.display = 'none';&#10;                    if (target.nextElementSibling) {&#10;                      (target.nextElementSibling as HTMLElement).style.display = 'flex';&#10;                    }&#10;                  }}&#10;                /&gt;&#10;              ) : null}&#10;              &lt;div&#10;                className=&quot;w-full h-full flex items-center justify-center bg-gradient-to-br from-[#d97757] to-[#c96846] text-white&quot;&#10;                style={{ display: avatar ? 'none' : 'flex' }}&#10;              &gt;&#10;                &lt;BookOpen className=&quot;w-5 h-5&quot; /&gt;&#10;              &lt;/div&gt;&#10;            &lt;/div&gt;&#10;            &lt;div className=&quot;flex-1 min-w-0&quot;&gt;&#10;              &lt;div className=&quot;text-sm font-semibold text-[#f5f1ed] flex items-center gap-2&quot;&gt;&#10;                &lt;span className=&quot;truncate&quot;&gt;{label}&lt;/span&gt;{user?.role === 'admin' &amp;&amp; (&#10;                  &lt;span title=&quot;Administrator&quot; aria-label=&quot;Administrator&quot; className=&quot;inline-flex items-center justify-center w-5 h-5 rounded-full bg-red-500/10 border border-red-500/30 text-red-400&quot;&gt;&#10;                    &lt;Shield className=&quot;w-3.5 h-3.5&quot; /&gt;&#10;                  &lt;/span&gt;&#10;                )}&#10;              &lt;/div&gt;&#10;              {user?.class &amp;&amp; (&#10;                &lt;div className=&quot;text-xs text-[#b8aea5]&quot;&gt;Klasse {user.class}&lt;/div&gt;&#10;              )}&#10;            &lt;/div&gt;&#10;            &lt;div&gt;&#10;              &lt;button&#10;                type=&quot;button&quot;&#10;                disabled={followBusy || !stats || stats.is_me}&#10;                onClick={async () =&gt; {&#10;                  if (!stats) return;&#10;                  const next = !stats.is_following;&#10;                  setFollowBusy(true);&#10;                  // optimistic update&#10;                  setStats({ ...stats, is_following: next, follower_count: stats.follower_count + (next ? 1 : -1) });&#10;                  try {&#10;                    const r = await fetch('/api/follow/toggle', {&#10;                      method: 'POST',&#10;                      headers: { 'Content-Type': 'application/json' },&#10;                      body: JSON.stringify({ userId }),&#10;                    });&#10;                    if (!r.ok) throw new Error('toggle failed');&#10;                  } catch {&#10;                    // revert on error&#10;                    setStats((s) =&gt; s ? { ...s, is_following: !next, follower_count: s.follower_count + (!next ? 1 : -1) } : s);&#10;                  } finally {&#10;                    setFollowBusy(false);&#10;                  }&#10;                }}&#10;                className={`px-3 py-1.5 text-xs rounded-md border transition-colors ${stats?.is_following ? 'bg-[#3a322b] border-[#e89a7a]/30 text-[#f5f1ed]' : 'bg-[#e89a7a]/15 border-[#e89a7a]/30 text-[#f5f1ed] hover:bg-[#e89a7a]/25'} ${followBusy || stats?.is_me ? 'opacity-60 cursor-not-allowed' : ''}`}&#10;                aria-label={stats?.is_following ? 'Entfolgen' : 'Folgen'}&#10;                title={stats?.is_me ? 'Das ist dein Profil' : (stats?.is_following ? 'Entfolgen' : 'Folgen')}&#10;              &gt;&#10;                {stats?.is_me ? 'Du' : stats?.is_following ? 'Entfolgen' : 'Folgen'}&#10;              &lt;/button&gt;&#10;            &lt;/div&gt;&#10;          &lt;/div&gt;&#10;&#10;          {stats &amp;&amp; (&#10;            &lt;div className=&quot;flex items-center gap-3 text-[11px] text-[#b8aea5] mb-2&quot;&gt;&#10;              &lt;div className=&quot;inline-flex items-center gap-1&quot;&gt;&lt;span className=&quot;text-[#f5f1ed] font-semibold&quot;&gt;{stats.follower_count}&lt;/span&gt; Follower&lt;/div&gt;&#10;              &lt;div className=&quot;inline-flex items-center gap-1&quot;&gt;&lt;span className=&quot;text-[#f5f1ed] font-semibold&quot;&gt;{stats.following_count}&lt;/span&gt; Folgt&lt;/div&gt;&#10;            &lt;/div&gt;&#10;          )}&#10;&#10;          {user?.role === 'admin' &amp;&amp; (&#10;            &lt;div className=&quot;mb-2 inline-flex items-center gap-2 px-2 py-1 rounded-md bg-red-500/10 text-red-300 border border-red-500/20 text-xs&quot; title=&quot;Administrator&quot;&gt;&#10;              &lt;Shield className=&quot;w-3 h-3&quot; aria-label=&quot;Administrator&quot; /&gt;&#10;              &lt;span&gt;Administrator – Mitglied des Admin-Teams&lt;/span&gt;&#10;            &lt;/div&gt;&#10;          )}&#10;          &lt;div className=&quot;text-sm text-[#b8aea5] whitespace-pre-wrap&quot;&gt;&#10;            {loading &amp;&amp; &lt;span className=&quot;opacity-70&quot;&gt;Lädt…&lt;/span&gt;}&#10;            {!loading &amp;&amp; (user?.bio ? user.bio : &lt;span className=&quot;opacity-70&quot;&gt;Keine Bio vorhanden.&lt;/span&gt;)}&#10;          &lt;/div&gt;&#10;        &lt;/div&gt;,&#10;        document.body&#10;      )}&#10;    &lt;/div&gt;&#10;  );&#10;}&#10;" />
              <option name="updatedContent" value="&quot;use client&quot;;&#10;&#10;import { useEffect, useRef, useState } from &quot;react&quot;;&#10;import { createPortal } from &quot;react-dom&quot;;&#10;import { BookOpen, Shield } from &quot;lucide-react&quot;;&#10;import { withBasePath } from &quot;@/lib/url&quot;;&#10;import AvatarImage from &quot;@/components/AvatarImage&quot;;&#10;import BannerImage from &quot;@/components/BannerImage&quot;;&#10;&#10;export type PublicUser = {&#10;  id: number;&#10;  username: string;&#10;  class: string | null;&#10;  bio: string | null;&#10;  avatar_url: string | null;&#10;  banner_url: string | null;&#10;  role: 'user' | 'moderator' | 'admin';&#10;};&#10;&#10;type Props = {&#10;  userId: number;&#10;  username?: string;&#10;  avatarUrl?: string | null;&#10;  size?: number; // px&#10;  className?: string;&#10;};&#10;&#10;export default function ProfileAvatar({ userId, username, avatarUrl, size = 28, className = &quot;&quot; }: Props) {&#10;  const [open, setOpen] = useState(false);&#10;  const [loading, setLoading] = useState(false);&#10;  const [followBusy, setFollowBusy] = useState(false);&#10;  const [user, setUser] = useState&lt;PublicUser | null&gt;(&#10;    username || avatarUrl ? { id: userId, username: username || &quot;&quot;, class: null, bio: null, avatar_url: avatarUrl ?? null, banner_url: null, role: 'user' } : null&#10;  );&#10;  const [stats, setStats] = useState&lt;{ follower_count: number; following_count: number; is_following: boolean; is_me?: boolean } | null&gt;(null);&#10;  const btnRef = useRef&lt;HTMLDivElement&gt;(null);&#10;  const popRef = useRef&lt;HTMLDivElement&gt;(null);&#10;  const [pos, setPos] = useState&lt;{ top: number; left: number; placement: 'top' | 'bottom' } | null&gt;(null);&#10;&#10;  useEffect(() =&gt; {&#10;    function onDocClick(e: MouseEvent) {&#10;      if (!open) return;&#10;      const t = e.target as Node;&#10;      if (btnRef.current &amp;&amp; btnRef.current.contains(t)) return;&#10;      if (popRef.current &amp;&amp; popRef.current.contains(t)) return;&#10;      setOpen(false);&#10;    }&#10;    document.addEventListener(&quot;mousedown&quot;, onDocClick);&#10;    return () =&gt; document.removeEventListener(&quot;mousedown&quot;, onDocClick);&#10;  }, [open]);&#10;&#10;  // Eagerly load avatar/public info so the profile image is visible without clicking&#10;  useEffect(() =&gt; {&#10;    // If avatar is already known via props or state, skip fetching&#10;    if (user?.avatar_url || avatarUrl) return;&#10;    let active = true;&#10;    fetch(`/api/users/public?userId=${userId}`)&#10;      .then(async (r) =&gt; {&#10;        if (!r.ok) throw new Error(&quot;load failed&quot;);&#10;        const data = await r.json();&#10;        if (!active) return;&#10;        setUser(data.user as PublicUser);&#10;        setStats(data.stats as { follower_count: number; following_count: number; is_following: boolean; is_me?: boolean });&#10;      })&#10;      .catch(() =&gt; {});&#10;    return () =&gt; { active = false; };&#10;  }, [userId]);&#10;&#10;  useEffect(() =&gt; {&#10;    if (!open) return;&#10;    if (user &amp;&amp; user.bio !== null) return; // already fetched full&#10;    setLoading(true);&#10;    fetch(`/api/users/public?userId=${userId}`)&#10;      .then(async (r) =&gt; {&#10;        if (!r.ok) throw new Error(&quot;load failed&quot;);&#10;        const data = await r.json();&#10;        setUser(data.user as PublicUser);&#10;        setStats(data.stats as { follower_count: number; following_count: number; is_following: boolean; is_me?: boolean });&#10;      })&#10;      .catch(() =&gt; {})&#10;      .finally(() =&gt; setLoading(false));&#10;  }, [open, userId]);&#10;&#10;  // Compute and update popover viewport position when opened and on scroll/resize&#10;  useEffect(() =&gt; {&#10;    if (!open) return;&#10;    function compute() {&#10;      const btn = btnRef.current;&#10;      const pop = popRef.current;&#10;      if (!btn || !pop) return;&#10;      const rect = btn.getBoundingClientRect();&#10;      const spacing = 8;&#10;      const popRect = pop.getBoundingClientRect();&#10;      let top = rect.bottom + spacing;&#10;      let placement: 'top' | 'bottom' = 'bottom';&#10;      if (top + popRect.height &gt; window.innerHeight - 8) {&#10;        top = Math.max(8, rect.top - spacing - popRect.height);&#10;        placement = 'top';&#10;      }&#10;      let left = rect.left;&#10;      if (left + popRect.width &gt; window.innerWidth - 8) {&#10;        left = Math.max(8, window.innerWidth - 8 - popRect.width);&#10;      }&#10;      if (left &lt; 8) left = 8;&#10;      setPos({ top, left, placement });&#10;    }&#10;    compute();&#10;    const handler = () =&gt; compute();&#10;    window.addEventListener('scroll', handler, true);&#10;    window.addEventListener('resize', handler);&#10;    return () =&gt; {&#10;      window.removeEventListener('scroll', handler, true);&#10;      window.removeEventListener('resize', handler);&#10;    };&#10;  }, [open]);&#10;&#10;  const avatar = user?.avatar_url ?? avatarUrl ?? null;&#10;  const avatarSrc = withBasePath(avatar);&#10;  const bannerSrc = withBasePath(user?.banner_url ?? null);&#10;  const label = user?.username || username || &quot;User&quot;;&#10;&#10;  return (&#10;    &lt;div className={`relative inline-flex items-center ${className}`}&gt;&#10;      &lt;div&#10;        ref={btnRef}&#10;        role=&quot;button&quot;&#10;        tabIndex={0}&#10;        aria-haspopup=&quot;dialog&quot;&#10;        aria-expanded={open}&#10;        onClick={(e) =&gt; { e.stopPropagation(); setOpen((v) =&gt; !v); }}&#10;        onKeyDown={(e) =&gt; {&#10;          if (e.key === 'Enter' || e.key === ' ') {&#10;            e.preventDefault();&#10;            e.stopPropagation();&#10;            setOpen((v) =&gt; !v);&#10;          }&#10;        }}&#10;        className=&quot;rounded-full border border-[#e89a7a]/20 overflow-hidden focus:outline-none focus:ring-2 focus:ring-[#e89a7a]/40&quot;&#10;        style={{ width: size, height: size }}&#10;        title={label}&#10;      &gt;&#10;        &lt;AvatarImage &#10;          src={avatarSrc} &#10;          alt={label} &#10;          className=&quot;w-full h-full&quot;&#10;          fallbackIcon={&lt;BookOpen className=&quot;w-3.5 h-3.5&quot; /&gt;}&#10;        /&gt;&#10;      &lt;/div&gt;&#10;&#10;      {open &amp;&amp; typeof window !== 'undefined' &amp;&amp; createPortal(&#10;        &lt;div&#10;          ref={popRef}&#10;          role=&quot;dialog&quot;&#10;          aria-label={`Profil von ${label}`}&#10;          className=&quot;fixed z-[1000] min-w-[260px] max-w-[360px] p-4 rounded-2xl border border-[#e89a7a]/20 bg-[#2a2520]/98 backdrop-blur-xl shadow-2xl&quot;&#10;          style={{ top: pos?.top ?? -9999, left: pos?.left ?? -9999 }}&#10;        &gt;&#10;          {user?.banner_url &amp;&amp; (&#10;            &lt;div className=&quot;-mt-1 -mx-1 mb-3 relative&quot;&gt;&#10;              &lt;BannerImage &#10;                src={bannerSrc} &#10;                alt=&quot;Profilbanner&quot; &#10;                className=&quot;w-full h-20 object-cover rounded-xl border border-[#e89a7a]/20&quot;&#10;                onLoad={() =&gt; {&#10;                  const btn = btnRef.current; &#10;                  const pop = popRef.current; &#10;                  if (!btn || !pop) return; &#10;                  const rect = btn.getBoundingClientRect(); &#10;                  const spacing = 8; &#10;                  const popRect = pop.getBoundingClientRect(); &#10;                  let top = rect.bottom + spacing; &#10;                  let placement: 'top' | 'bottom' = 'bottom'; &#10;                  if (top + popRect.height &gt; window.innerHeight - 8) { &#10;                    top = Math.max(8, rect.top - spacing - popRect.height); &#10;                    placement = 'top'; &#10;                  } &#10;                  let left = rect.left; &#10;                  if (left + popRect.width &gt; window.innerWidth - 8) { &#10;                    left = Math.max(8, window.innerWidth - 8 - popRect.width); &#10;                  } &#10;                  if (left &lt; 8) left = 8; &#10;                  setPos({ top, left, placement });&#10;                }}&#10;              /&gt;&#10;            &lt;/div&gt;&#10;          )}&#10;          &lt;div className=&quot;flex items-center gap-3 mb-3&quot;&gt;&#10;            &lt;div className=&quot;w-12 h-12 rounded-xl overflow-hidden border border-[#e89a7a]/20&quot;&gt;&#10;              &lt;AvatarImage &#10;                src={avatarSrc} &#10;                alt={label} &#10;                className=&quot;w-full h-full&quot;&#10;                fallbackIcon={&lt;BookOpen className=&quot;w-5 h-5&quot; /&gt;}&#10;              /&gt;&#10;            &lt;/div&gt;&#10;            &lt;div className=&quot;flex-1 min-w-0&quot;&gt;&#10;              &lt;div className=&quot;text-sm font-semibold text-[#f5f1ed] flex items-center gap-2&quot;&gt;&#10;                &lt;span className=&quot;truncate&quot;&gt;{label}&lt;/span&gt;{user?.role === 'admin' &amp;&amp; (&#10;                  &lt;span title=&quot;Administrator&quot; aria-label=&quot;Administrator&quot; className=&quot;inline-flex items-center justify-center w-5 h-5 rounded-full bg-red-500/10 border border-red-500/30 text-red-400&quot;&gt;&#10;                    &lt;Shield className=&quot;w-3.5 h-3.5&quot; /&gt;&#10;                  &lt;/span&gt;&#10;                )}&#10;              &lt;/div&gt;&#10;              {user?.class &amp;&amp; (&#10;                &lt;div className=&quot;text-xs text-[#b8aea5]&quot;&gt;Klasse {user.class}&lt;/div&gt;&#10;              )}&#10;            &lt;/div&gt;&#10;            &lt;div&gt;&#10;              &lt;button&#10;                type=&quot;button&quot;&#10;                disabled={followBusy || !stats || stats.is_me}&#10;                onClick={async () =&gt; {&#10;                  if (!stats) return;&#10;                  const next = !stats.is_following;&#10;                  setFollowBusy(true);&#10;                  // optimistic update&#10;                  setStats({ ...stats, is_following: next, follower_count: stats.follower_count + (next ? 1 : -1) });&#10;                  try {&#10;                    const r = await fetch('/api/follow/toggle', {&#10;                      method: 'POST',&#10;                      headers: { 'Content-Type': 'application/json' },&#10;                      body: JSON.stringify({ userId }),&#10;                    });&#10;                    if (!r.ok) throw new Error('toggle failed');&#10;                  } catch {&#10;                    // revert on error&#10;                    setStats((s) =&gt; s ? { ...s, is_following: !next, follower_count: s.follower_count + (!next ? 1 : -1) } : s);&#10;                  } finally {&#10;                    setFollowBusy(false);&#10;                  }&#10;                }}&#10;                className={`px-3 py-1.5 text-xs rounded-md border transition-colors ${stats?.is_following ? 'bg-[#3a322b] border-[#e89a7a]/30 text-[#f5f1ed]' : 'bg-[#e89a7a]/15 border-[#e89a7a]/30 text-[#f5f1ed] hover:bg-[#e89a7a]/25'} ${followBusy || stats?.is_me ? 'opacity-60 cursor-not-allowed' : ''}`}&#10;                aria-label={stats?.is_following ? 'Entfolgen' : 'Folgen'}&#10;                title={stats?.is_me ? 'Das ist dein Profil' : (stats?.is_following ? 'Entfolgen' : 'Folgen')}&#10;              &gt;&#10;                {stats?.is_me ? 'Du' : stats?.is_following ? 'Entfolgen' : 'Folgen'}&#10;              &lt;/button&gt;&#10;            &lt;/div&gt;&#10;          &lt;/div&gt;&#10;&#10;          {stats &amp;&amp; (&#10;            &lt;div className=&quot;flex items-center gap-3 text-[11px] text-[#b8aea5] mb-2&quot;&gt;&#10;              &lt;div className=&quot;inline-flex items-center gap-1&quot;&gt;&lt;span className=&quot;text-[#f5f1ed] font-semibold&quot;&gt;{stats.follower_count}&lt;/span&gt; Follower&lt;/div&gt;&#10;              &lt;div className=&quot;inline-flex items-center gap-1&quot;&gt;&lt;span className=&quot;text-[#f5f1ed] font-semibold&quot;&gt;{stats.following_count}&lt;/span&gt; Folgt&lt;/div&gt;&#10;            &lt;/div&gt;&#10;          )}&#10;&#10;          {user?.role === 'admin' &amp;&amp; (&#10;            &lt;div className=&quot;mb-2 inline-flex items-center gap-2 px-2 py-1 rounded-md bg-red-500/10 text-red-300 border border-red-500/20 text-xs&quot; title=&quot;Administrator&quot;&gt;&#10;              &lt;Shield className=&quot;w-3 h-3&quot; aria-label=&quot;Administrator&quot; /&gt;&#10;              &lt;span&gt;Administrator – Mitglied des Admin-Teams&lt;/span&gt;&#10;            &lt;/div&gt;&#10;          )}&#10;          &lt;div className=&quot;text-sm text-[#b8aea5] whitespace-pre-wrap&quot;&gt;&#10;            {loading &amp;&amp; &lt;span className=&quot;opacity-70&quot;&gt;Lädt…&lt;/span&gt;}&#10;            {!loading &amp;&amp; (user?.bio ? user.bio : &lt;span className=&quot;opacity-70&quot;&gt;Keine Bio vorhanden.&lt;/span&gt;)}&#10;          &lt;/div&gt;&#10;        &lt;/div&gt;,&#10;        document.body&#10;      )}&#10;    &lt;/div&gt;&#10;  );&#10;}&#10;" />
            </PendingDiffInfo>
          </value>
        </entry>
        <entry key="$PROJECT_DIR$/scripts/force-dark-footer.js">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/scripts/force-dark-footer.js" />
              <option name="updatedContent" value="const fs = require('fs');&#10;const path = require('path');&#10;const file = path.resolve(__dirname, '..', 'components', 'Footer.tsx');&#10;let src = fs.readFileSync(file, 'utf8');&#10;&#10;// Ersetzungen: Light/Dark-Mix -&gt; feste Dark-Standards&#10;src = src.replace(/text-\[#2a2520\]\s+dark:text-\[#f5f1ed\]/g, 'text-[#f5f1ed]');&#10;src = src.replace(/text-\[#6b635a\]\s+dark:text-\[#b8aea5\]/g, 'text-[#b8aea5]');&#10;src = src.replace(/hover:text-\[#d97757\]\s+dark:hover:text-\[#e89a7a\]/g, 'hover:text-[#e89a7a]');&#10;src = src.replace(/border-\[#d97757\]\/10\s+dark:border-\[#e89a7a\]\/10/g, 'border-[#e89a7a]/10');&#10;&#10;// Falls noch einzelne dark:-Reste vorhanden sind (Sicherheitsnetz):&#10;src = src.replace(/\sdark:[^\s&quot;]+/g, '');&#10;&#10;fs.writeFileSync(file, src, 'utf8');&#10;console.log('Footer.tsx dark:-Varianten entfernt und Dark als Standard gesetzt.');&#10;" />
            </PendingDiffInfo>
          </value>
        </entry>
      </map>
    </option>
  </component>
</project>